<?xml version="1.0" encoding="utf-8" ?>
<ContentPage x:Class="SubExplore.Views.Favorites.FavoriteSpotsPage"
             xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             xmlns:vm="clr-namespace:SubExplore.ViewModels.Favorites"
             xmlns:models="clr-namespace:SubExplore.Models.Domain"
             xmlns:local="clr-namespace:SubExplore.Helpers.Converters"
             x:DataType="vm:FavoriteSpotsViewModel"
             Title="{Binding Title}">
    
    <ContentPage.Resources>
        <ResourceDictionary>
            <!-- Converters -->
            <local:NotificationFilterConverter x:Key="NotificationFilterConverter" />
            <local:DifficultyToColorConverter x:Key="DifficultyToColorConverter" />
            <local:FavoriteCountConverter x:Key="FavoriteCountConverter" />
            <local:TimeSinceConverter x:Key="TimeSinceConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,*">

        <!-- Search and Filter Section -->
        <Frame Grid.Row="0" 
               Padding="15"
               BackgroundColor="{StaticResource Background}"
               BorderColor="Transparent">
            <StackLayout Spacing="15">
                
                <!-- Statistics Cards -->
                <Grid ColumnDefinitions="*,*,*" ColumnSpacing="10" IsVisible="{Binding FavoriteStats, Converter={StaticResource IsNotNullConverter}}">
                    
                    <!-- Total Favoris -->
                    <Frame Grid.Column="0"
                           BackgroundColor="{StaticResource Primary}"
                           CornerRadius="12"
                           HasShadow="False"
                           Padding="12,8">
                        <StackLayout Spacing="2">
                            <Label Text="{Binding FavoriteStats.TotalFavorites}"
                                   FontSize="20"
                                   FontAttributes="Bold"
                                   TextColor="White"
                                   HorizontalOptions="Center" />
                            <Label Text="Total"
                                   FontSize="11"
                                   TextColor="White"
                                   HorizontalOptions="Center" />
                        </StackLayout>
                    </Frame>
                    
                    <!-- Notifications -->
                    <Frame Grid.Column="1"
                           BackgroundColor="{StaticResource Secondary}"
                           CornerRadius="12"
                           HasShadow="False"
                           Padding="12,8">
                        <StackLayout Spacing="2">
                            <Label Text="{Binding FavoriteStats.NotificationEnabled}"
                                   FontSize="20"
                                   FontAttributes="Bold"
                                   TextColor="White"
                                   HorizontalOptions="Center" />
                            <Label Text="Notifiés"
                                   FontSize="11"
                                   TextColor="White"
                                   HorizontalOptions="Center" />
                        </StackLayout>
                    </Frame>
                    
                    <!-- Activités -->
                    <Frame Grid.Column="2"
                           BackgroundColor="#4CAF50"
                           CornerRadius="12"
                           HasShadow="False"
                           Padding="12,8">
                        <StackLayout Spacing="2">
                            <Label Text="{Binding FavoriteStats.ActivityFavorites}"
                                   FontSize="20"
                                   FontAttributes="Bold"
                                   TextColor="White"
                                   HorizontalOptions="Center" />
                            <Label Text="Activités"
                                   FontSize="11"
                                   TextColor="White"
                                   HorizontalOptions="Center" />
                        </StackLayout>
                    </Frame>
                </Grid>

                <!-- Search and Filter Controls -->
                <Grid ColumnDefinitions="*,Auto,Auto" ColumnSpacing="10">
                    
                    <!-- Search Entry -->
                    <Frame Grid.Column="0"
                           BackgroundColor="{StaticResource Surface}"
                           BorderColor="{StaticResource BorderColor}"
                           CornerRadius="8"
                           Padding="0"
                           HasShadow="False">
                        <Entry Text="{Binding SearchText}"
                               Placeholder="Rechercher dans vos favoris..."
                               BackgroundColor="Transparent"
                               TextColor="{StaticResource TextPrimary}"
                               PlaceholderColor="{StaticResource TextSecondary}"
                               FontSize="16"
                               AutomationId="SearchEntry"
                               SemanticProperties.Description="Rechercher parmi vos favoris"
                               SemanticProperties.Hint="Tapez pour rechercher par nom, description ou type" />
                    </Frame>
                    
                    <!-- Filter Button -->
                    <Button Grid.Column="1"
                            Text="⚙"
                            FontSize="18"
                            WidthRequest="50"
                            HeightRequest="50"
                            CornerRadius="25"
                            BackgroundColor="{StaticResource Primary}"
                            TextColor="White"
                            Command="{Binding ShowActivityFilterCommand}"
                            AutomationId="FilterButton"
                            SemanticProperties.Description="Filtrer par type d'activité" />
                    
                    <!-- Clear Search Button -->
                    <Button Grid.Column="2"
                            Text="×"
                            FontSize="20"
                            WidthRequest="50"
                            HeightRequest="50"
                            CornerRadius="25"
                            BackgroundColor="{StaticResource Secondary}"
                            TextColor="White"
                            Command="{Binding ClearSearchCommand}"
                            AutomationId="ClearSearchButton"
                            SemanticProperties.Description="Effacer la recherche"
                            SemanticProperties.Hint="Appuyez pour effacer la recherche" />
                </Grid>
            </StackLayout>
        </Frame>

        <!-- Content Area -->
        <Grid Grid.Row="1">
            <!-- Loading indicator -->
            <ActivityIndicator IsVisible="{Binding IsLoading}"
                             IsRunning="{Binding IsLoading}"
                             Color="{StaticResource Primary}"
                             VerticalOptions="Center"
                             HorizontalOptions="Center" />

            <!-- Error state -->
            <StackLayout IsVisible="{Binding IsError}"
                       VerticalOptions="Center"
                       HorizontalOptions="Center"
                       Padding="32">
                <Label Text="" 
                       FontSize="48" 
                       HorizontalOptions="Center" />
                <Label Text="{Binding ErrorMessage}"
                       FontSize="16"
                       HorizontalOptions="Center"
                       HorizontalTextAlignment="Center"
                       TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}" />
                <Button Text="Réessayer"
                        Command="{Binding RefreshCommand}"
                        Style="{StaticResource PrimaryButtonStyle}"
                        Margin="0,16,0,0" />
            </StackLayout>

            <!-- Empty state -->
            <StackLayout IsVisible="{Binding HasFavorites, Converter={StaticResource InvertedBoolConverter}}"
                       VerticalOptions="Center"
                       HorizontalOptions="Center"
                       Padding="32">
                       
                <!-- Animated Empty State Icon -->
                <Frame BackgroundColor="Transparent"
                       BorderColor="{StaticResource Primary}"
                       CornerRadius="50"
                       WidthRequest="100"
                       HeightRequest="100"
                       HasShadow="False"
                       Padding="0">
                    <Label Text="" 
                           FontSize="48" 
                           HorizontalOptions="Center"
                           VerticalOptions="Center" />
                </Frame>
                
                <Label Text="Aucun favori pour le moment"
                       FontSize="20"
                       FontAttributes="Bold"
                       HorizontalOptions="Center"
                       Margin="0,16,0,8" />
                       
                <Label Text="{Binding EmptyStateMessage}"
                       FontSize="16"
                       HorizontalOptions="Center"
                       HorizontalTextAlignment="Center"
                       TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}"
                       Margin="0,0,0,24" />
                       
                <!-- Quick Start Actions -->
                <StackLayout Spacing="12">
                    <Button Text="Explorer la carte"
                            Command="{Binding ExploreMapCommand}"
                            Style="{StaticResource PrimaryButtonStyle}"
                            WidthRequest="250" />
                            
                    <Button Text="Voir mes spots"
                            Command="{Binding ViewMySpotsCommand}"
                            Style="{StaticResource SecondaryButtonStyle}"
                            WidthRequest="250" />
                            
                    <Button Text="Importer des favoris"
                            Command="{Binding ImportFavoritesCommand}"
                            Style="{StaticResource SecondaryButtonStyle}"
                            WidthRequest="250" />
                </StackLayout>
                
                <!-- Tips -->
                <Frame BackgroundColor="{AppThemeBinding Light={StaticResource Warning}, Dark={StaticResource WarningDark}}"
                       Padding="16"
                       CornerRadius="8"
                       Margin="0,24,0,0"
                       MaximumWidthRequest="300">
                    <StackLayout Spacing="8">
                        <Label Text="Astuce"
                               FontSize="14"
                               FontAttributes="Bold"
                               TextColor="White" />
                        <Label Text="Explorez la carte pour découvrir des spots incroyables et ajoutez-les à vos favoris d'un simple clic !"
                               FontSize="12"
                               TextColor="White" />
                    </StackLayout>
                </Frame>
            </StackLayout>

            <!-- Favorites list -->
            <RefreshView IsVisible="{Binding HasFavorites}"
                        IsRefreshing="{Binding IsRefreshing}"
                        Command="{Binding RefreshCommand}">
                
                <CollectionView ItemsSource="{Binding FavoriteSpots}"
                              SelectionMode="None">
                    
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:UserFavoriteSpot">
                            <Grid Padding="16,8">
                                <Border BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray800}}"
                                       Stroke="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray700}}"
                                       StrokeThickness="1"
                                       StrokeShape="RoundRectangle 12">
                                    
                                    <Grid Padding="16">
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto" />
                                            <RowDefinition Height="*" />
                                            <RowDefinition Height="Auto" />
                                            <RowDefinition Height="Auto" />
                                            <RowDefinition Height="Auto" />
                                        </Grid.RowDefinitions>


                                        <!-- Spot info -->
                                        <Grid Grid.Row="1">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*" />
                                                <ColumnDefinition Width="Auto" />
                                            </Grid.ColumnDefinitions>

                                            <StackLayout Grid.Column="0">
                                            <!-- Spot title with activity indicator -->
                                            <Grid ColumnDefinitions="Auto,*" ColumnSpacing="8" Margin="0,0,0,8">
                                                <Label Grid.Column="0"
                                                       Text="📍" 
                                                       FontSize="16" 
                                                       VerticalOptions="Center" />
                                                <Label Grid.Column="1"
                                                       Text="{Binding Spot.Name}" 
                                                       FontSize="18" 
                                                       FontAttributes="Bold"
                                                       TextColor="{StaticResource Primary}"
                                                       LineBreakMode="WordWrap"
                                                       MaxLines="2"
                                                       VerticalOptions="Start" />
                                            </Grid>
                                            
                                            <!-- Date added -->
                                            <Label Text="{Binding CreatedAt, Converter={StaticResource TimeSinceConverter}}" 
                                                   FontSize="10" 
                                                   TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray500}}"
                                                   Margin="0,0,0,8" />
                                                
                                                <Label Text="{Binding Spot.Type.Name}" 
                                                       FontSize="14"
                                                       FontAttributes="Bold"
                                                       TextColor="{Binding Spot.DifficultyLevel, Converter={StaticResource DifficultyToColorConverter}}" />
                                                
                                                <Label Text="{Binding Spot.Description}" 
                                                       FontSize="14"
                                                       TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}"
                                                       MaxLines="2"
                                                       LineBreakMode="TailTruncation" />
                                            </StackLayout>

                                            <!-- Difficulty and depth -->
                                            <StackLayout Grid.Column="1" 
                                                       VerticalOptions="Start"
                                                       HorizontalOptions="End"
                                                       Spacing="4">
                                                <Border BackgroundColor="{Binding Spot.DifficultyLevel, Converter={StaticResource DifficultyToColorConverter}}"
                                                        StrokeThickness="0"
                                                        StrokeShape="RoundRectangle 12"
                                                        Padding="8,4">
                                                    <Label Text="{Binding Spot.DifficultyLevel}" 
                                                           FontSize="12"
                                                           TextColor="White"
                                                           FontAttributes="Bold"
                                                           HorizontalTextAlignment="Center" />
                                                </Border>
                                                
                                                <Label Text="{Binding Spot.MaxDepth, StringFormat='{0}m'}" 
                                                       FontSize="12"
                                                       FontAttributes="Bold"
                                                       TextColor="{StaticResource Primary}"
                                                       HorizontalTextAlignment="Center" />
                                                
                                                <Label Text="{Binding Spot.Type.Category}" 
                                                       FontSize="10"
                                                       TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}"
                                                       HorizontalTextAlignment="Center" />
                                            </StackLayout>
                                        </Grid>

                                        <!-- Notes -->
                                        <Label Grid.Row="2"
                                              Text="{Binding Notes}"
                                              FontSize="12"
                                              FontAttributes="Italic"
                                              TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray500}}"
                                              IsVisible="{Binding Notes, Converter={StaticResource IsNotNullOrEmptyConverter}}"
                                              Margin="0,8,0,0" />

                                        <!-- Activity type and date info -->
                                        <StackLayout Grid.Row="3" Orientation="Horizontal" Spacing="10" Margin="0,8,0,0">
                                            <Label Text="{Binding Spot.Type.Name}"
                                                   FontSize="12"
                                                   TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}" />
                                            <Label Text="•"
                                                   FontSize="12"
                                                   TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}" />
                                            <Label Text="{Binding CreatedAt, StringFormat='{0:dd/MM/yyyy}'}"
                                                   FontSize="12"
                                                   TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}" />
                                        </StackLayout>

                                        <!-- Action Buttons Row -->
                                        <Grid Grid.Row="4" ColumnDefinitions="*,*,*" ColumnSpacing="8" Margin="0,12,0,0">
                                            
                                            <!-- Notification toggle -->
                                            <Button Grid.Column="0"
                                                    Text="{Binding NotificationEnabled, Converter={StaticResource BoolToObjectConverter}, ConverterParameter='🔔|🔕'}"
                                                    FontSize="16"
                                                    HeightRequest="44"
                                                    CornerRadius="8"
                                                    BackgroundColor="{StaticResource Surface}"
                                                    BorderColor="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}"
                                                    BorderWidth="1"
                                                    Command="{Binding Source={x:RelativeSource AncestorType={x:Type vm:FavoriteSpotsViewModel}}, Path=ToggleNotificationCommand}"
                                                    CommandParameter="{Binding .}"
                                                    AutomationId="NotificationButton"
                                                    SemanticProperties.Description="Activer/désactiver les notifications" />

                                            <!-- View details -->
                                            <Button Grid.Column="1"
                                                    Text="👁"
                                                    FontSize="16"
                                                    HeightRequest="44"
                                                    CornerRadius="8"
                                                    BackgroundColor="{StaticResource Primary}"
                                                    TextColor="White"
                                                    Command="{Binding Source={x:RelativeSource AncestorType={x:Type vm:FavoriteSpotsViewModel}}, Path=ViewSpotDetailsCommand}"
                                                    CommandParameter="{Binding .}"
                                                    AutomationId="ViewDetailsButton"
                                                    SemanticProperties.Description="Voir les détails du spot" />

                                            <!-- Remove favorite -->
                                            <Button Grid.Column="2"
                                                    Text="×"
                                                    FontSize="20"
                                                    FontAttributes="Bold"
                                                    HeightRequest="44"
                                                    CornerRadius="8"
                                                    BackgroundColor="#FF4444"
                                                    TextColor="White"
                                                    Command="{Binding Source={x:RelativeSource AncestorType={x:Type vm:FavoriteSpotsViewModel}}, Path=RemoveFromFavoritesCommand}"
                                                    CommandParameter="{Binding .}"
                                                    AutomationId="RemoveFavoriteButton"
                                                    SemanticProperties.Description="Retirer des favoris" />
                                        </Grid>
                                    </Grid>
                                </Border>

                                <!-- Tap gesture for main item -->
                                <Grid.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding Source={x:RelativeSource AncestorType={x:Type vm:FavoriteSpotsViewModel}}, Path=ViewSpotDetailsCommand}"
                                                        CommandParameter="{Binding .}" />
                                </Grid.GestureRecognizers>
                            </Grid>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </RefreshView>
        </Grid>
        
        <!-- Floating Action Button -->
        <Button Grid.Row="1"
                Text="+"
                FontSize="24"
                FontAttributes="Bold"
                BackgroundColor="{StaticResource Primary}"
                TextColor="White"
                WidthRequest="56"
                HeightRequest="56"
                CornerRadius="28"
                HorizontalOptions="End"
                VerticalOptions="End"
                Margin="0,0,16,16"
                Command="{Binding ExploreMapCommand}"
                AutomationId="AddFavoriteButton"
                SemanticProperties.Description="Explorer pour ajouter des favoris" />
    </Grid>
</ContentPage>