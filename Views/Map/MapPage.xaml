<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="SubExplore.Views.Map.MapPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:maps="clr-namespace:Microsoft.Maui.Controls.Maps;assembly=Microsoft.Maui.Controls.Maps"
    xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
    xmlns:converters="clr-namespace:SubExplore.Helpers.Converters"
    xmlns:viewmodels="clr-namespace:SubExplore.ViewModels.Map"
    Title="Carte"
    BackgroundColor="{StaticResource Background}">
    
    <ContentPage.Resources>
        <converters:ResponsiveMarginConverter x:Key="ResponsiveMarginConverter" />
        <converters:ResponsiveFontSizeConverter x:Key="ResponsiveFontSizeConverter" />
        <converters:ResponsiveHeightConverter x:Key="ResponsiveHeightConverter" />
    </ContentPage.Resources>


    <ContentPage.Behaviors>
        <toolkit:EventToCommandBehavior Command="{Binding InitializeCommand}" EventName="Appearing" />
    </ContentPage.Behaviors>

    <RefreshView Command="{Binding LoadSpotsCommand}" IsRefreshing="{Binding IsBusy}">
        <Grid RowDefinitions="Auto,Auto,*,Auto">
        <!--  Barre de recherche amÃ©liorÃ©e  -->
        <Frame
            Grid.Row="0"
            Margin="{Binding Source={x:Static Device.RuntimePlatform}, Converter={StaticResource ResponsiveMarginConverter}, ConverterParameter='8:10:12'}"
            Padding="5"
            BackgroundColor="{StaticResource Surface}"
            BorderColor="{StaticResource Secondary}"
            CornerRadius="25"
            HasShadow="True"
            AutomationId="SearchFrame"
            SemanticProperties.Description="Zone de recherche de spots">
            <Grid ColumnDefinitions="*,Auto">
                <Entry
                    Grid.Column="0"
                    Margin="5,0"
                    ClearButtonVisibility="WhileEditing"
                    Placeholder="Rechercher un spot..."
                    ReturnCommand="{Binding SearchSpotsCommand}"
                    ReturnType="Search"
                    Text="{Binding SearchText}"
                    FontSize="{Binding Source={x:Static Device.RuntimePlatform}, Converter={StaticResource ResponsiveFontSizeConverter}, ConverterParameter='1.0'}"
                    IsEnabled="{Binding IsSearching, Converter={StaticResource InvertBoolConverter}}"
                    AutomationId="SearchEntry"
                    SemanticProperties.Description="Rechercher des spots de plongÃ©e par nom ou localisation"
                    SemanticProperties.Hint="Entrez le nom d'un spot ou d'une localisation pour effectuer une recherche">
                    <Entry.Behaviors>
                        <toolkit:EventToCommandBehavior EventName="TextChanged" Command="{Binding SearchTextChangedCommand}" />
                    </Entry.Behaviors>
                </Entry>
                <Button
                    Grid.Column="1"
                    Command="{Binding SearchSpotsCommand}"
                    Style="{StaticResource ButtonActionStyle}"
                    Text="ðŸ”"
                    IsEnabled="{Binding IsSearching, Converter={StaticResource InvertBoolConverter}}"
                    AutomationId="SearchButton"
                    SemanticProperties.Description="Lancer la recherche de spots"
                    SemanticProperties.Hint="Appuyez pour rechercher des spots correspondant au texte saisi">
                    <Button.Triggers>
                        <DataTrigger TargetType="Button" Binding="{Binding IsSearching}" Value="True">
                            <Setter Property="Text" Value="â³" />
                        </DataTrigger>
                    </Button.Triggers>
                </Button>
            </Grid>
        </Frame>

        <!--  Barre de filtres amÃ©liorÃ©e  -->
        <ScrollView 
            Grid.Row="1"
            Margin="{Binding Source={x:Static Device.RuntimePlatform}, Converter={StaticResource ResponsiveMarginConverter}, ConverterParameter='8:10:12'}"
            HorizontalScrollBarVisibility="Never" 
            Orientation="Horizontal"
            AutomationId="FiltersScrollView"
            SemanticProperties.Description="Zone de filtres des spots - Balayez horizontalement pour voir plus d'options"
            SemanticProperties.Hint="Balayez vers la droite pour dÃ©couvrir d'autres types de spots">
            <HorizontalStackLayout Spacing="6" Padding="8,8,24,8">
                <Button
                    Command="{Binding ClearFiltersCommand}"
                    Style="{StaticResource ButtonFilterStyle}"
                    Text="Tous"
                    FontSize="{Binding Source={x:Static Device.RuntimePlatform}, Converter={StaticResource ResponsiveFontSizeConverter}, ConverterParameter='0.9'}"
                    CornerRadius="8"
                    Padding="14,8"
                    AutomationId="ClearFiltersButton"
                    SemanticProperties.Description="Afficher tous les types de spots"
                    SemanticProperties.Hint="Appuyez pour supprimer tous les filtres et afficher tous les spots">
                    <Button.Triggers>
                        <DataTrigger TargetType="Button" Binding="{Binding SelectedSpotType}" Value="{x:Null}">
                            <Setter Property="BackgroundColor" Value="{StaticResource Primary}" />
                            <Setter Property="TextColor" Value="White" />
                        </DataTrigger>
                        <DataTrigger TargetType="Button" Binding="{Binding SelectedSpotType}" Value="{x:Null}">
                            <Setter Property="BackgroundColor" Value="{StaticResource Surface}" />
                            <Setter Property="TextColor" Value="{StaticResource Primary}" />
                        </DataTrigger>
                    </Button.Triggers>
                </Button>

                <CollectionView
                    ItemsSource="{Binding SpotTypes}"
                    SelectedItem="{Binding SelectedSpotType}"
                    SelectionChangedCommand="{Binding FilterSpotsByTypeCommand}"
                    SelectionChangedCommandParameter="{Binding SelectedSpotType}"
                    SelectionMode="Single"
                    AutomationId="SpotTypesFilter"
                    SemanticProperties.Description="Filtrer les spots par type d'activitÃ© - Balayez pour voir plus d'options">
                    <CollectionView.ItemsLayout>
                        <LinearItemsLayout ItemSpacing="6" Orientation="Horizontal" />
                    </CollectionView.ItemsLayout>
                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <Button
                                BackgroundColor="{Binding ColorCode}"
                                Style="{StaticResource ButtonFilterStyle}"
                                Text="{Binding Name}"
                                TextColor="White"
                                FontSize="{Binding Source={x:Static Device.RuntimePlatform}, Converter={StaticResource ResponsiveFontSizeConverter}, ConverterParameter='0.9'}"
                                CornerRadius="8"
                                Padding="14,8"
                                Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:MapViewModel}}, Path=FilterSpotsByTypeCommand}"
                                CommandParameter="{Binding .}"
                                AutomationId="{Binding Name, StringFormat='Filter{0}Button'}"
                                SemanticProperties.Description="{Binding Name, StringFormat='Filtrer par {0}'}"
                                SemanticProperties.Hint="{Binding Name, StringFormat='Appuyez pour afficher uniquement les spots de type {0}'}" />
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </HorizontalStackLayout>
        </ScrollView>

        <!--  Carte responsive  -->
        <Grid Grid.Row="2">
            <maps:Map
                x:Name="MainMap"
                IsShowingUser="{Binding IsLocationAvailable}"
                ItemsSource="{Binding Pins}"
                MapClicked="OnMapClicked"
                MapType="Street"
                HorizontalOptions="FillAndExpand"
                VerticalOptions="FillAndExpand"
                IsZoomEnabled="True"
                IsScrollEnabled="True"
                AutomationId="MainMap"
                SemanticProperties.Description="Carte interactive des spots de plongÃ©e"
                SemanticProperties.Hint="Explorez les spots de plongÃ©e sur la carte, appuyez sur un marqueur pour voir les dÃ©tails">
            <maps:Map.MapElements>
                <!--  Vous pouvez ajouter des Ã©lÃ©ments de carte personnalisÃ©s ici  -->
            </maps:Map.MapElements>
            </maps:Map>
            
            <!--  Ã‰tat vide  -->
            <StackLayout
                IsVisible="{Binding IsEmptyState}"
                HorizontalOptions="Center"
                VerticalOptions="Center"
                Spacing="10">
                <Label
                    Text="ðŸ—ºï¸"
                    FontSize="48"
                    HorizontalOptions="Center" />
                <Label
                    Text="Aucun spot trouvÃ©"
                    Style="{StaticResource SubHeadline}"
                    HorizontalOptions="Center" />
                <Label
                    Text="Essayez d'ajuster vos filtres ou votre recherche"
                    Style="{StaticResource Caption}"
                    HorizontalOptions="Center"
                    HorizontalTextAlignment="Center" />
            </StackLayout>
            
            <!--  Ã‰tat d'erreur rÃ©seau  -->
            <StackLayout
                IsVisible="{Binding IsNetworkError}"
                HorizontalOptions="Center"
                VerticalOptions="Center"
                Spacing="10">
                <Label
                    Text="ðŸ“¶"
                    FontSize="48"
                    HorizontalOptions="Center" />
                <Label
                    Text="Connexion limitÃ©e"
                    Style="{StaticResource SubHeadline}"
                    HorizontalOptions="Center" />
                <Button
                    Text="RÃ©essayer"
                    Command="{Binding LoadSpotsCommand}"
                    Style="{StaticResource ButtonPrimaryStyle}"
                    HorizontalOptions="Center" />
            </StackLayout>
        </Grid>

        <!--  Barre d'actions amÃ©liorÃ©e  -->
        <Frame
            Grid.Row="3"
            Margin="{Binding Source={x:Static Device.RuntimePlatform}, Converter={StaticResource ResponsiveMarginConverter}, ConverterParameter='8:10:12'}"
            Padding="0"
            BackgroundColor="{StaticResource Surface}"
            BorderColor="{StaticResource Secondary}"
            CornerRadius="25"
            HasShadow="True"
            AutomationId="ActionsFrame"
            SemanticProperties.Description="Barre d'actions principales">
            <Grid Padding="5" ColumnDefinitions="*,*,Auto">
                <Button
                    Grid.Column="0"
                    Command="{Binding LoadSpotsCommand}"
                    Style="{StaticResource ButtonActionStyle}"
                    Text="Actualiser"
                    FontSize="{Binding Source={x:Static Device.RuntimePlatform}, Converter={StaticResource ResponsiveFontSizeConverter}, ConverterParameter='0.9'}"
                    IsEnabled="{Binding IsBusy, Converter={StaticResource InvertBoolConverter}}"
                    AutomationId="RefreshSpotsButton"
                    SemanticProperties.Description="Actualiser les spots sur la carte"
                    SemanticProperties.Hint="Appuyez pour recharger les spots depuis le serveur">
                    <Button.Triggers>
                        <DataTrigger TargetType="Button" Binding="{Binding IsBusy}" Value="True">
                            <Setter Property="Text" Value="ðŸ”„" />
                        </DataTrigger>
                    </Button.Triggers>
                </Button>
                <Button
                    Grid.Column="1"
                    Command="{Binding RefreshLocationCommand}"
                    Style="{StaticResource ButtonActionStyle}"
                    FontSize="{Binding Source={x:Static Device.RuntimePlatform}, Converter={StaticResource ResponsiveFontSizeConverter}, ConverterParameter='0.9'}"
                    AutomationId="MyLocationButton"
                    SemanticProperties.Description="Centrer la carte sur ma position actuelle"
                    SemanticProperties.Hint="Appuyez pour obtenir votre position GPS et centrer la carte">
                    <Button.Triggers>
                        <DataTrigger TargetType="Button" Binding="{Binding IsLocationAvailable}" Value="True">
                            <Setter Property="Text" Value="ðŸ“ Ma position" />
                        </DataTrigger>
                        <DataTrigger TargetType="Button" Binding="{Binding IsLocationAvailable}" Value="False">
                            <Setter Property="Text" Value="ðŸ“ Localiser" />
                        </DataTrigger>
                    </Button.Triggers>
                </Button>
                <Button
                    Grid.Column="2"
                    Command="{Binding NavigateToAddSpotCommand}"
                    Style="{StaticResource ButtonPrimaryStyle}"
                    Text="âž• Nouveau"
                    FontSize="{Binding Source={x:Static Device.RuntimePlatform}, Converter={StaticResource ResponsiveFontSizeConverter}, ConverterParameter='0.9'}"
                    Padding="15,8"
                    AutomationId="AddSpotButton"
                    SemanticProperties.Description="Ajouter un nouveau spot de plongÃ©e"
                    SemanticProperties.Hint="Appuyez pour commencer l'ajout d'un nouveau spot" />
            </Grid>
        </Frame>

        <!--  Indicateur de chargement amÃ©liorÃ©  -->
        <Grid
            Grid.Row="0"
            Grid.RowSpan="4"
            IsVisible="{Binding IsBusy}"
            BackgroundColor="{AppThemeBinding Light=#80000000, Dark=#80FFFFFF}"
            AutomationId="LoadingOverlay">
            <Frame
                HorizontalOptions="Center"
                VerticalOptions="Center"
                BackgroundColor="{StaticResource Surface}"
                CornerRadius="15"
                Padding="20"
                HasShadow="True">
                <StackLayout Orientation="Horizontal" Spacing="10">
                    <ActivityIndicator
                        IsRunning="{Binding IsBusy}"
                        Color="{StaticResource Primary}"
                        AutomationId="LoadingIndicator" />
                    <Label
                        Text="Chargement..."
                        VerticalOptions="Center"
                        Style="{StaticResource BodyText}"
                        SemanticProperties.Description="Chargement des donnÃ©es en cours"
                        SemanticProperties.Hint="Veuillez patienter pendant le chargement des spots" />
                </StackLayout>
            </Frame>
        </Grid>

        </Grid>
    </RefreshView>
</ContentPage>