<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="SubExplore.Views.Map.MapPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:maps="clr-namespace:Microsoft.Maui.Controls.Maps;assembly=Microsoft.Maui.Controls.Maps"
    xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
    xmlns:viewmodels="clr-namespace:SubExplore.ViewModels.Map"
    Title="Carte"
    BackgroundColor="{StaticResource Background}">


    <ContentPage.Behaviors>
        <toolkit:EventToCommandBehavior Command="{Binding InitializeCommand}" EventName="Appearing" />
    </ContentPage.Behaviors>

    <Grid RowDefinitions="Auto,Auto,*,Auto">
        <!--  Barre de recherche  -->
        <Frame
            Grid.Row="0"
            Margin="10,5"
            Padding="5"
            BackgroundColor="{StaticResource Surface}"
            BorderColor="{StaticResource Secondary}"
            CornerRadius="25">
            <Grid ColumnDefinitions="*,Auto">
                <Entry
                    Grid.Column="0"
                    Margin="5,0"
                    ClearButtonVisibility="WhileEditing"
                    Placeholder="Rechercher un spot..."
                    ReturnCommand="{Binding SearchSpotsCommand}"
                    ReturnType="Search"
                    Text="{Binding SearchText}"
                    AutomationId="SearchEntry"
                    SemanticProperties.Description="Rechercher des spots de plongÃ©e par nom ou localisation"
                    SemanticProperties.Hint="Entrez le nom d'un spot ou d'une localisation pour effectuer une recherche" />
                <Button
                    Grid.Column="1"
                    Command="{Binding SearchSpotsCommand}"
                    Style="{StaticResource ButtonActionStyle}"
                    Text="ðŸ”"
                    AutomationId="SearchButton"
                    SemanticProperties.Description="Lancer la recherche de spots"
                    SemanticProperties.Hint="Appuyez pour rechercher des spots correspondant au texte saisi" />
            </Grid>
        </Frame>

        <!--  Barre de filtres  -->
        <Frame
            Grid.Row="1"
            Margin="10,0,10,5"
            Padding="5"
            BackgroundColor="{StaticResource Surface}"
            BorderColor="{StaticResource Secondary}"
            CornerRadius="25">
            <ScrollView HorizontalScrollBarVisibility="Never" Orientation="Horizontal">
                <HorizontalStackLayout Spacing="5">
                    <Button
                        BackgroundColor="{StaticResource Primary}"
                        Command="{Binding ClearFiltersCommand}"
                        Style="{StaticResource ButtonFilterStyle}"
                        Text="Tous"
                        TextColor="White"
                        AutomationId="ClearFiltersButton"
                        SemanticProperties.Description="Afficher tous les types de spots"
                        SemanticProperties.Hint="Appuyez pour supprimer tous les filtres et afficher tous les spots" />

                    <CollectionView
                        ItemsSource="{Binding SpotTypes}"
                        SelectedItem="{Binding SelectedSpotType}"
                        SelectionChangedCommand="{Binding FilterSpotsByTypeCommand}"
                        SelectionChangedCommandParameter="{Binding SelectedSpotType}"
                        SelectionMode="Single"
                        AutomationId="SpotTypesFilter"
                        SemanticProperties.Description="Filtrer les spots par type d'activitÃ©">
                        <CollectionView.ItemsLayout>
                            <LinearItemsLayout ItemSpacing="5" Orientation="Horizontal" />
                        </CollectionView.ItemsLayout>
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Button
                                    BackgroundColor="{Binding ColorCode}"
                                    Style="{StaticResource ButtonFilterStyle}"
                                    Text="{Binding Name}"
                                    TextColor="White"
                                    AutomationId="{Binding Name, StringFormat='Filter{0}Button'}"
                                    SemanticProperties.Description="{Binding Name, StringFormat='Filtrer par {0}'}"
                                    SemanticProperties.Hint="{Binding Name, StringFormat='Appuyez pour afficher uniquement les spots de type {0}'}" />
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </HorizontalStackLayout>
            </ScrollView>
        </Frame>

        <!--  Carte  -->
        <maps:Map
            Grid.Row="2"
            x:Name="MainMap"
            IsShowingUser="{Binding IsLocationAvailable}"
            ItemsSource="{Binding Pins}"
            MapClicked="OnMapClicked"
            MapType="Street"
            HeightRequest="400"
            HorizontalOptions="FillAndExpand"
            VerticalOptions="FillAndExpand"
            IsZoomEnabled="True"
            IsScrollEnabled="True"
            AutomationId="MainMap"
            SemanticProperties.Description="Carte interactive des spots de plongÃ©e"
            SemanticProperties.Hint="Explorez les spots de plongÃ©e sur la carte, appuyez sur un marqueur pour voir les dÃ©tails">
            <maps:Map.MapElements>
                <!--  Vous pouvez ajouter des Ã©lÃ©ments de carte personnalisÃ©s ici  -->
            </maps:Map.MapElements>
        </maps:Map>

        <!--  Barre d'actions  -->
        <Frame
            Grid.Row="3"
            Margin="10,5"
            Padding="0"
            BackgroundColor="{StaticResource Surface}"
            BorderColor="{StaticResource Secondary}"
            CornerRadius="25">
            <Grid Padding="5" ColumnDefinitions="*,*,*">
                <Button
                    Grid.Column="0"
                    Command="{Binding LoadSpotsCommand}"
                    Style="{StaticResource ButtonActionStyle}"
                    Text="Actualiser"
                    AutomationId="RefreshSpotsButton"
                    SemanticProperties.Description="Actualiser les spots sur la carte"
                    SemanticProperties.Hint="Appuyez pour recharger les spots depuis le serveur" />
                <Button
                    Grid.Column="1"
                    Command="{Binding RefreshLocationCommand}"
                    Style="{StaticResource ButtonActionStyle}"
                    Text="Ma position"
                    AutomationId="MyLocationButton"
                    SemanticProperties.Description="Centrer la carte sur ma position actuelle"
                    SemanticProperties.Hint="Appuyez pour obtenir votre position GPS et centrer la carte" />
                <Button
                    Grid.Column="2"
                    Command="{Binding NavigateToAddSpotCommand}"
                    Style="{StaticResource ButtonPrimaryStyle}"
                    Text="Nouveau"
                    AutomationId="AddSpotButton"
                    SemanticProperties.Description="Ajouter un nouveau spot de plongÃ©e"
                    SemanticProperties.Hint="Appuyez pour commencer l'ajout d'un nouveau spot" />
            </Grid>
        </Frame>

        <!--  Indicateur de chargement  -->
        <ActivityIndicator
            Grid.Row="0"
            Grid.RowSpan="4"
            HorizontalOptions="Center"
            IsRunning="{Binding IsBusy}"
            IsVisible="{Binding IsBusy}"
            VerticalOptions="Center"
            Color="{StaticResource Primary}"
            AutomationId="LoadingIndicator"
            SemanticProperties.Description="Chargement des donnÃ©es en cours"
            SemanticProperties.Hint="Veuillez patienter pendant le chargement des spots" />

    </Grid>
</ContentPage>