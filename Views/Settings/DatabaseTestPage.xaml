<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="SubExplore.Views.Settings.DatabaseTestPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:converters="clr-namespace:SubExplore.Helpers.Converters"
    xmlns:viewmodels="clr-namespace:SubExplore.ViewModels.Settings"
    Title="{Binding Title}"
    x:DataType="viewmodels:DatabaseTestViewModel">

    <ContentPage.Resources>
        <converters:BoolToColorConverter x:Key="BoolToColorConverter" />
    </ContentPage.Resources>

    <ScrollView>
        <StackLayout Padding="20" Spacing="15">
            <Label
                FontAttributes="Bold"
                FontSize="20"
                Text="Status de la Base de DonnÃ©es" />
            <Frame
                Padding="15"
                BorderColor="#DDDDDD"
                CornerRadius="10">
                <StackLayout Spacing="10">
                    <Label FontAttributes="Bold" Text="Ã‰tat de la connexion" />
                    <Label Text="{Binding CanConnect, StringFormat='Connexion: {0}'}" TextColor="Magenta" />
                    <Button Command="{Binding TestConnectionCommand}" Text="Tester la connexion" />
                </StackLayout>
            </Frame>
            <Frame
                Padding="15"
                BorderColor="#DDDDDD"
                CornerRadius="10">
                <StackLayout Spacing="10">
                    <Label FontAttributes="Bold" Text="Structure de la base de donnÃ©es" />
                    <Label Text="{Binding IsDataSeeded, StringFormat='DonnÃ©es initialisÃ©es: {0}'}" TextColor="Magenta" />
                    <Button Command="{Binding EnsureDatabaseCreatedCommand}" Text="CrÃ©er le schÃ©ma" />
                </StackLayout>
            </Frame>
            <Frame
                Padding="15"
                BorderColor="#DDDDDD"
                CornerRadius="10">
                <StackLayout Spacing="10">
                    <Label FontAttributes="Bold" Text="DonnÃ©es initiales" />
                    <Label Text="{Binding IsDataSeeded, StringFormat='DonnÃ©es initialisÃ©es: {0}'}">
                        <Label.Triggers>
                            <DataTrigger
                                Binding="{Binding IsDataSeeded}"
                                TargetType="Label"
                                Value="True">
                                <Setter Property="TextColor" Value="Green" />
                            </DataTrigger>
                            <DataTrigger
                                Binding="{Binding IsDataSeeded}"
                                TargetType="Label"
                                Value="False">
                                <Setter Property="TextColor" Value="Red" />
                            </DataTrigger>
                        </Label.Triggers>
                    </Label>
                    <Button Command="{Binding SeedDatabaseCommand}" Text="Initialiser les donnÃ©es" />
                </StackLayout>
            </Frame>
            <Frame
                Padding="15"
                BorderColor="#FFAA00"
                CornerRadius="10">
                <StackLayout Spacing="10">
                    <Label FontAttributes="Bold" Text="ðŸ§¹ Nettoyage des filtres" />
                    <Label Text="{Binding IsSpotTypesCleanedUp, StringFormat='Types de spots nettoyÃ©s: {0}'}">
                        <Label.Triggers>
                            <DataTrigger
                                Binding="{Binding IsSpotTypesCleanedUp}"
                                TargetType="Label"
                                Value="True">
                                <Setter Property="TextColor" Value="Green" />
                            </DataTrigger>
                            <DataTrigger
                                Binding="{Binding IsSpotTypesCleanedUp}"
                                TargetType="Label"
                                Value="False">
                                <Setter Property="TextColor" Value="Red" />
                            </DataTrigger>
                        </Label.Triggers>
                    </Label>
                    <Label Text="Supprime les anciens filtres et ne garde que les 5 types requis" FontSize="12" TextColor="Gray" />
                    <Button Command="{Binding CleanupSpotTypesCommand}" Text="ðŸ§¹ Nettoyer les filtres obsolÃ¨tes" BackgroundColor="#FF6B35" TextColor="White" />
                </StackLayout>
            </Frame>
            <Frame
                Padding="15"
                BorderColor="#00AA00"
                CornerRadius="10">
                <StackLayout Spacing="10">
                    <Label FontAttributes="Bold" Text="ðŸ“ Import des spots rÃ©els" />
                    <Label Text="{Binding IsRealSpotsImported, StringFormat='Spots rÃ©els importÃ©s: {0}'}">
                        <Label.Triggers>
                            <DataTrigger
                                Binding="{Binding IsRealSpotsImported}"
                                TargetType="Label"
                                Value="True">
                                <Setter Property="TextColor" Value="Green" />
                            </DataTrigger>
                            <DataTrigger
                                Binding="{Binding IsRealSpotsImported}"
                                TargetType="Label"
                                Value="False">
                                <Setter Property="TextColor" Value="Red" />
                            </DataTrigger>
                        </Label.Triggers>
                    </Label>
                    <Label Text="Importe les spots depuis le fichier Data/real_spots.json" FontSize="12" TextColor="Gray" />
                    <Button Command="{Binding ImportRealSpotsCommand}" Text="ðŸ“ Importer les spots rÃ©els" BackgroundColor="#28A745" TextColor="White" />
                </StackLayout>
            </Frame>
            
            <Frame
                Padding="15"
                BorderColor="#0066CC"
                CornerRadius="10">
                <StackLayout Spacing="10">
                    <Label FontAttributes="Bold" Text="ðŸ” Diagnostic de base de donnÃ©es" />
                    <Label Text="Affiche les statistiques dÃ©taillÃ©es sur le contenu de la base de donnÃ©es" FontSize="12" TextColor="Gray" />
                    <Button Command="{Binding ShowDatabaseDiagnosticsCommand}" Text="ðŸ” Afficher les diagnostics" BackgroundColor="#0066CC" TextColor="White" />
                </StackLayout>
            </Frame>
            
            <Frame
                Padding="15"
                BorderColor="#DC3545"
                CornerRadius="10">
                <StackLayout Spacing="10">
                    <Label FontAttributes="Bold" Text="ðŸš¨ Diagnostic ultra-profond" />
                    <Label Text="Test ultra-complet de la connectivitÃ©, des tables, des donnÃ©es et des services" FontSize="12" TextColor="Gray" />
                    <Button Command="{Binding RunUltraDeepDiagnosticCommand}" Text="ðŸš¨ Diagnostic ultra-profond" BackgroundColor="#DC3545" TextColor="White" />
                </StackLayout>
            </Frame>

            <Frame
                Padding="15"
                BorderColor="#9B59B6"
                CornerRadius="10">
                <StackLayout Spacing="10">
                    <Label FontAttributes="Bold" Text="ðŸ” Diagnostic dÃ©taillÃ© des types de spots" />
                    <Label Text="Analyse complÃ¨te des types de spots, catÃ©gories et extensions pour la nouvelle organisation" FontSize="12" TextColor="Gray" />
                    <Button Command="{Binding RunDetailedDatabaseDiagnosticCommand}" Text="ðŸ” Diagnostic dÃ©taillÃ©" BackgroundColor="#9B59B6" TextColor="White" />
                </StackLayout>
            </Frame>

            <Frame
                Padding="15"
                BorderColor="#E74C3C"
                CornerRadius="10">
                <StackLayout Spacing="10">
                    <Label FontAttributes="Bold" Text="ðŸ”„ RecrÃ©ation forcÃ©e des donnÃ©es" />
                    <Label Text="âš ï¸ DANGER: Supprime TOUTES les donnÃ©es et recrÃ©e la base avec les 8 nouveaux types de spots" FontSize="12" TextColor="Gray" />
                    <Button Command="{Binding ForceRecreateDataCommand}" Text="ðŸ”„ RecrÃ©er les donnÃ©es" BackgroundColor="#E74C3C" TextColor="White" />
                </StackLayout>
            </Frame>

            <Frame
                Padding="15"
                BorderColor="#27AE60"
                CornerRadius="10">
                <StackLayout Spacing="10">
                    <Label FontAttributes="Bold" Text="ðŸŽ¯ Migration EF Core des types de spots" />
                    <Label Text="âœ… RECOMMANDÃ‰: Migre la base existante vers les 8 nouveaux types (prÃ©serve les donnÃ©es)" FontSize="12" TextColor="Gray" />
                    <Button Command="{Binding ExecuteSpotTypeMigrationCommand}" Text="ðŸŽ¯ ExÃ©cuter la migration EF Core" BackgroundColor="#27AE60" TextColor="White" />
                </StackLayout>
            </Frame>

            <Frame
                Padding="15"
                BorderColor="#3498DB"
                CornerRadius="10">
                <StackLayout Spacing="10">
                    <Label FontAttributes="Bold" Text="ðŸ“Š Ã‰tat de la migration" />
                    <Label Text="VÃ©rifie si la migration a Ã©tÃ© appliquÃ©e et affiche le statut dÃ©taillÃ©" FontSize="12" TextColor="Gray" />
                    <Button Command="{Binding CheckMigrationStatusCommand}" Text="ðŸ“Š VÃ©rifier l'Ã©tat" BackgroundColor="#3498DB" TextColor="White" />
                </StackLayout>
            </Frame>

            <Frame
                Padding="15"
                BorderColor="#FF6F00"
                CornerRadius="10">
                <StackLayout Spacing="10">
                    <Label FontAttributes="Bold" Text="ðŸ”§ ExÃ©cuter la migration de catÃ©gories" />
                    <Label Text="{Binding IsCategoryMigrationExecuted, StringFormat='Migration exÃ©cutÃ©e: {0}'}">
                        <Label.Triggers>
                            <DataTrigger
                                Binding="{Binding IsCategoryMigrationExecuted}"
                                TargetType="Label"
                                Value="True">
                                <Setter Property="TextColor" Value="Green" />
                            </DataTrigger>
                            <DataTrigger
                                Binding="{Binding IsCategoryMigrationExecuted}"
                                TargetType="Label"
                                Value="False">
                                <Setter Property="TextColor" Value="Red" />
                            </DataTrigger>
                        </Label.Triggers>
                    </Label>
                    <Label Text="ExÃ©cute la migration FixSpotTypeCategoryMapping pour mettre Ã  jour les catÃ©gories existantes" FontSize="12" TextColor="Gray" />
                    <Button Command="{Binding ExecuteCategoryMappingMigrationCommand}" Text="ðŸ”§ ExÃ©cuter migration" BackgroundColor="#FF6F00" TextColor="White" />
                </StackLayout>
            </Frame>

            <Frame
                Padding="15"
                BorderColor="#9C27B0"
                CornerRadius="10">
                <StackLayout Spacing="10">
                    <Label FontAttributes="Bold" Text="ðŸ” Analyser les problÃ¨mes de filtrage" />
                    <Label Text="Diagnostic approfondi du systÃ¨me de filtrage par catÃ©gorie aprÃ¨s migration" FontSize="12" TextColor="Gray" />
                    <Button Command="{Binding AnalyzeFilteringIssuesCommand}" Text="ðŸ” Analyser filtrage" BackgroundColor="#9C27B0" TextColor="White" />
                </StackLayout>
            </Frame>
            
            <Frame
                Padding="15"
                BorderColor="#E91E63"
                CornerRadius="10">
                <StackLayout Spacing="10">
                    <Label FontAttributes="Bold" Text="ðŸ”§ Corriger la structure ActivityCategory" />
                    <Label>
                        <Label.Triggers>
                            <DataTrigger
                                Binding="{Binding IsCategoryStructureMigrated}"
                                TargetType="Label"
                                Value="True">
                                <Setter Property="Text" Value="âœ… Structure corrigÃ©e" />
                                <Setter Property="TextColor" Value="Green" />
                            </DataTrigger>
                            <DataTrigger
                                Binding="{Binding IsCategoryStructureMigrated}"
                                TargetType="Label"
                                Value="False">
                                <Setter Property="Text" Value="âŒ Structure Ã  corriger" />
                                <Setter Property="TextColor" Value="Red" />
                            </DataTrigger>
                        </Label.Triggers>
                    </Label>
                    <Label Text="Corrige le problÃ¨me architectural: Boutiques apparaissant dans Structures" FontSize="12" TextColor="Gray" />
                    <Button Command="{Binding FixActivityCategoryStructureCommand}" Text="ðŸ”§ Corriger structure" BackgroundColor="#E91E63" TextColor="White" />
                </StackLayout>
            </Frame>
            
            <Frame
                Padding="15"
                BorderColor="#FF5722"
                CornerRadius="10">
                <StackLayout Spacing="10">
                    <Label FontAttributes="Bold" Text="ðŸ©º Diagnostic des types de spots" />
                    <Label Text="Analyse complÃ¨te de l'Ã©tat des types de spots et dÃ©tection des problÃ¨mes" FontSize="12" TextColor="Gray" />
                    <Button Command="{Binding DiagnoseSpotTypesCommand}" Text="ðŸ©º Diagnostiquer" BackgroundColor="#FF5722" TextColor="White" />
                </StackLayout>
            </Frame>
            
            <Frame
                Padding="15"
                BorderColor="#4CAF50"
                CornerRadius="10">
                <StackLayout Spacing="10">
                    <Label FontAttributes="Bold" Text="ðŸ› ï¸ RÃ©parer les types de spots" />
                    <Label>
                        <Label.Triggers>
                            <DataTrigger
                                Binding="{Binding IsSpotTypesRepaired}"
                                TargetType="Label"
                                Value="True">
                                <Setter Property="Text" Value="âœ… Types rÃ©parÃ©s" />
                                <Setter Property="TextColor" Value="Green" />
                            </DataTrigger>
                            <DataTrigger
                                Binding="{Binding IsSpotTypesRepaired}"
                                TargetType="Label"
                                Value="False">
                                <Setter Property="Text" Value="âŒ RÃ©paration requise" />
                                <Setter Property="TextColor" Value="Red" />
                            </DataTrigger>
                        </Label.Triggers>
                    </Label>
                    <Label Text="Corrige automatiquement les doublons et rÃ©pare les liens spots â†” types" FontSize="12" TextColor="Gray" />
                    <Button Command="{Binding RepairSpotTypesCommand}" Text="ðŸ› ï¸ RÃ©parer" BackgroundColor="#4CAF50" TextColor="White" />
                </StackLayout>
            </Frame>
            
            <!-- Section des logs -->
            <Frame
                Padding="15"
                BackgroundColor="#F8F8F8"
                BorderColor="#DDDDDD"
                CornerRadius="10"
                HeightRequest="200">
                <ScrollView>
                    <Label
                        FontFamily="{OnPlatform Default='monospace', Android='monospace', iOS='Courier', WinUI='Consolas'}"
                        FontSize="12"
                        Text="{Binding LogMessages}" />
                </ScrollView>
            </Frame>
            
            <!-- Indicateur de chargement -->
            <ActivityIndicator
                HorizontalOptions="Center"
                IsRunning="{Binding IsLoading}"
                IsVisible="{Binding IsLoading}"
                VerticalOptions="Center" />
                
        </StackLayout>
    </ScrollView>
</ContentPage>