<?xml version="1.0" encoding="utf-8" ?>
<ContentPage x:Class="SubExplore.Views.Profile.UserStatsPage"
             xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:SubExplore.ViewModels.Profile"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             x:DataType="vm:UserStatsViewModel"
             Title="{Binding Title}">

    <ContentPage.Resources>
        <ResourceDictionary>
            <toolkit:InvertedBoolConverter x:Key="InvertBoolConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <ScrollView>
        <StackLayout Padding="16" Spacing="20">
            
            <!-- Loading Indicator -->
            <ActivityIndicator IsVisible="{Binding IsLoading}" 
                             IsRunning="{Binding IsLoading}"
                             Color="{StaticResource Primary}"
                             VerticalOptions="Center" />

            <!-- Error Message -->
            <Label Text="{Binding ErrorMessage}"
                   TextColor="Red"
                   FontSize="14"
                   HorizontalTextAlignment="Center"
                   IsVisible="{Binding IsError}" />

            <!-- Stats Content -->
            <StackLayout IsVisible="{Binding IsLoading, Converter={StaticResource InvertBoolConverter}}" Spacing="20">
                
                <!-- Évolution de l'utilisateur -->
                <Frame BackgroundColor="{StaticResource Primary}" HasShadow="True" CornerRadius="12">
                    <StackLayout Spacing="16">
                        <Label Text="Votre Évolution" 
                               FontSize="20" 
                               FontAttributes="Bold" 
                               TextColor="White" 
                               HorizontalTextAlignment="Center" />
                        
                        <!-- Statut utilisateur -->
                        <Label Text="{Binding UserStatusDisplay}"
                               FontSize="14"
                               TextColor="White"
                               HorizontalTextAlignment="Center"
                               FontAttributes="Bold"
                               Margin="0,4,0,8" />

                        <!-- Niveau actuel -->
                        <StackLayout Spacing="8">
                            <Label Text="{Binding ContributionLevel}"
                                   FontSize="24"
                                   FontAttributes="Bold"
                                   TextColor="White"
                                   HorizontalTextAlignment="Center" />
                            
                            <Label Text="{Binding LevelDescription}"
                                   FontSize="14"
                                   TextColor="White"
                                   HorizontalTextAlignment="Center"
                                   Margin="10,0" />
                        </StackLayout>

                        <!-- Information sur le prochain niveau -->
                        <StackLayout Spacing="8">
                            <Label Text="{Binding NextLevelInfo}"
                                   FontSize="12"
                                   TextColor="White"
                                   HorizontalTextAlignment="Center"
                                   FontAttributes="Italic" />
                            
                            <!-- Barre d'évolution avec échelons premium -->
                            <StackLayout Spacing="4">
                                <!-- Barre de progression principale -->
                                <ProgressBar Progress="{Binding OverallProgress}"
                                             ProgressColor="{StaticResource Success}"
                                             BackgroundColor="White"
                                             HeightRequest="12"
                                             Margin="0,4" />
                                
                                <!-- Échelons premium avec marqueurs -->
                                <Grid Margin="0,-8,0,0">
                                    <!-- Marqueurs positionnés proportionnellement (10% = 10 spots, 25% = 25 spots, 50% = 50 spots, 100% = 100 spots) -->
                                    
                                    <!-- 10 spots = 1 mois premium (10% de la barre) -->
                                    <StackLayout HorizontalOptions="Start" Margin="25,0,0,0">
                                        <Ellipse Fill="{StaticResource Warning}" 
                                                WidthRequest="14" 
                                                HeightRequest="14" 
                                                Stroke="White" 
                                                StrokeThickness="2"/>
                                        <Label Text="10" 
                                               FontSize="9" 
                                               TextColor="White" 
                                               HorizontalTextAlignment="Center"
                                               Margin="0,-2,0,0"/>
                                        <Label Text="1m" 
                                               FontSize="7" 
                                               TextColor="White" 
                                               HorizontalTextAlignment="Center"
                                               FontAttributes="Bold"/>
                                    </StackLayout>
                                    
                                    <!-- 25 spots = 3 mois premium (25% de la barre) -->
                                    <StackLayout HorizontalOptions="Start" Margin="62,0,0,0">
                                        <Ellipse Fill="#CD7F32" 
                                                WidthRequest="14" 
                                                HeightRequest="14" 
                                                Stroke="White" 
                                                StrokeThickness="2"/>
                                        <Label Text="25" 
                                               FontSize="9" 
                                               TextColor="White" 
                                               HorizontalTextAlignment="Center"
                                               Margin="0,-2,0,0"/>
                                        <Label Text="3m" 
                                               FontSize="7" 
                                               TextColor="White" 
                                               HorizontalTextAlignment="Center"
                                               FontAttributes="Bold"/>
                                    </StackLayout>
                                    
                                    <!-- 50 spots = 6 mois premium (50% de la barre) -->
                                    <StackLayout HorizontalOptions="Center">
                                        <Ellipse Fill="#C0C0C0" 
                                                WidthRequest="15" 
                                                HeightRequest="15" 
                                                Stroke="White" 
                                                StrokeThickness="2"/>
                                        <Label Text="50" 
                                               FontSize="9" 
                                               TextColor="White" 
                                               HorizontalTextAlignment="Center"
                                               Margin="0,-2,0,0"/>
                                        <Label Text="6m" 
                                               FontSize="7" 
                                               TextColor="White" 
                                               HorizontalTextAlignment="Center"
                                               FontAttributes="Bold"/>
                                    </StackLayout>
                                    
                                    <!-- 100 spots = 12 mois premium (100% de la barre) -->
                                    <StackLayout HorizontalOptions="End" Margin="0,0,15,0">
                                        <Ellipse Fill="#FFD700" 
                                                WidthRequest="16" 
                                                HeightRequest="16" 
                                                Stroke="White" 
                                                StrokeThickness="2"/>
                                        <Label Text="100" 
                                               FontSize="8" 
                                               TextColor="White" 
                                               HorizontalTextAlignment="Center"
                                               Margin="0,-2,0,0"/>
                                        <Label Text="12m" 
                                               FontSize="7" 
                                               TextColor="White" 
                                               HorizontalTextAlignment="Center"
                                               FontAttributes="Bold"/>
                                    </StackLayout>
                                </Grid>
                                
                                <!-- Information premium si éligible -->
                                <Label Text="{Binding PremiumStatusInfo}"
                                       FontSize="12"
                                       TextColor="White"
                                       HorizontalTextAlignment="Center"
                                       FontAttributes="Bold"
                                       IsVisible="{Binding HasPremiumReward}"
                                       Margin="0,8,0,0" />
                                       
                                <!-- Légende des échelons premium (modérateurs uniquement) -->
                                <Label Text="🏆 Récompenses Premium pour modérateurs !"
                                       FontSize="10"
                                       TextColor="White"
                                       HorizontalTextAlignment="Center"
                                       FontAttributes="Italic"
                                       IsVisible="{Binding IsUserModerator}"
                                       Margin="0,4,0,0" />
                                       
                                <!-- Message pour les utilisateurs standards -->
                                <Label Text="💪 Continuez à partager pour faire grandir la communauté !"
                                       FontSize="10"
                                       TextColor="White"
                                       HorizontalTextAlignment="Center"
                                       FontAttributes="Italic"
                                       IsVisible="{Binding IsUserModerator, Converter={StaticResource InvertBoolConverter}}"
                                       Margin="0,4,0,0" />
                            </StackLayout>
                        </StackLayout>

                        <!-- Spots validés mis en avant -->
                        <Grid ColumnDefinitions="*,*,*">
                            <StackLayout Grid.Column="1" HorizontalOptions="Center">
                                <Label Text="{Binding UserStats.ValidatedSpots}"
                                       FontSize="32"
                                       FontAttributes="Bold"
                                       TextColor="White"
                                       HorizontalTextAlignment="Center" />
                                <Label Text="Spots Validés"
                                       FontSize="14"
                                       TextColor="White"
                                       HorizontalTextAlignment="Center" />
                            </StackLayout>
                        </Grid>
                    </StackLayout>
                </Frame>
                
                <!-- General Stats -->
                <Frame BackgroundColor="{StaticResource Gray100}" HasShadow="True" CornerRadius="12">
                    <StackLayout Spacing="16">
                        <Label Text="Statistiques Générales" 
                               FontSize="18" 
                               FontAttributes="Bold" 
                               TextColor="{StaticResource Primary}" />

                        <Grid RowDefinitions="Auto,Auto,Auto,Auto" ColumnDefinitions="*,*">
                            <!-- Total Spots -->
                            <StackLayout Grid.Row="0" Grid.Column="0" HorizontalOptions="Center">
                                <Label Text="{Binding UserStats.TotalSpots}"
                                       FontSize="24"
                                       FontAttributes="Bold"
                                       TextColor="{StaticResource Primary}"
                                       HorizontalTextAlignment="Center" />
                                <Label Text="Total Spots"
                                       FontSize="12"
                                       TextColor="{StaticResource Gray600}"
                                       HorizontalTextAlignment="Center" />
                            </StackLayout>

                            <!-- Pending Spots -->
                            <StackLayout Grid.Row="0" Grid.Column="1" HorizontalOptions="Center">
                                <Label Text="{Binding UserStats.PendingSpots}"
                                       FontSize="24"
                                       FontAttributes="Bold"
                                       TextColor="{StaticResource Warning}"
                                       HorizontalTextAlignment="Center" />
                                <Label Text="En Attente"
                                       FontSize="12"
                                       TextColor="{StaticResource Gray600}"
                                       HorizontalTextAlignment="Center" />
                            </StackLayout>

                            <!-- Total Photos -->
                            <StackLayout Grid.Row="1" Grid.Column="0" HorizontalOptions="Center">
                                <Label Text="{Binding UserStats.TotalPhotos}"
                                       FontSize="24"
                                       FontAttributes="Bold"
                                       TextColor="{StaticResource Info}"
                                       HorizontalTextAlignment="Center" />
                                <Label Text="Total Photos"
                                       FontSize="12"
                                       TextColor="{StaticResource Gray600}"
                                       HorizontalTextAlignment="Center" />
                            </StackLayout>

                            <!-- Validation Rate -->
                            <StackLayout Grid.Row="1" Grid.Column="1" HorizontalOptions="Center">
                                <Label Text="{Binding ValidationRate}"
                                       FontSize="20"
                                       FontAttributes="Bold"
                                       TextColor="{StaticResource Success}"
                                       HorizontalTextAlignment="Center" />
                                <Label Text="Taux de Validation"
                                       FontSize="12"
                                       TextColor="{StaticResource Gray600}"
                                       HorizontalTextAlignment="Center" />
                            </StackLayout>

                            <!-- Photos per Spot -->
                            <StackLayout Grid.Row="2" Grid.Column="0" HorizontalOptions="Center">
                                <Label Text="{Binding PhotosPerSpotDisplay}"
                                       FontSize="20"
                                       FontAttributes="Bold"
                                       TextColor="{StaticResource Info}"
                                       HorizontalTextAlignment="Center" />
                                <Label Text="Photos par Spot"
                                       FontSize="12"
                                       TextColor="{StaticResource Gray600}"
                                       HorizontalTextAlignment="Center" />
                            </StackLayout>

                            <!-- Contribution Score -->
                            <StackLayout Grid.Row="2" Grid.Column="1" HorizontalOptions="Center">
                                <Label Text="{Binding UserStats.ContributionScore}"
                                       FontSize="20"
                                       FontAttributes="Bold"
                                       TextColor="{StaticResource Warning}"
                                       HorizontalTextAlignment="Center" />
                                <Label Text="Score de Contribution"
                                       FontSize="12"
                                       TextColor="{StaticResource Gray600}"
                                       HorizontalTextAlignment="Center" />
                            </StackLayout>
                        </Grid>
                    </StackLayout>
                </Frame>

                <!-- Diving Stats -->
                <Frame BackgroundColor="{StaticResource Gray100}" HasShadow="True" CornerRadius="12" IsVisible="{Binding HasSpots}">
                    <StackLayout Spacing="16">
                        <Label Text="Statistiques de Plongée" 
                               FontSize="18" 
                               FontAttributes="Bold" 
                               TextColor="{StaticResource Primary}" />

                        <Grid RowDefinitions="Auto,Auto,Auto" ColumnDefinitions="*,*">
                            <!-- Average Depth -->
                            <StackLayout Grid.Row="0" Grid.Column="0" HorizontalOptions="Center">
                                <Label Text="{Binding AverageDepthDisplay}"
                                       FontSize="20"
                                       FontAttributes="Bold"
                                       TextColor="{StaticResource Primary}"
                                       HorizontalTextAlignment="Center" />
                                <Label Text="Profondeur Moyenne"
                                       FontSize="12"
                                       TextColor="{StaticResource Gray600}"
                                       HorizontalTextAlignment="Center" />
                            </StackLayout>

                            <!-- Max Depth -->
                            <StackLayout Grid.Row="0" Grid.Column="1" HorizontalOptions="Center">
                                <Label Text="{Binding MaxDepthDisplay}"
                                       FontSize="20"
                                       FontAttributes="Bold"
                                       TextColor="{StaticResource Danger}"
                                       HorizontalTextAlignment="Center" />
                                <Label Text="Profondeur Maximale"
                                       FontSize="12"
                                       TextColor="{StaticResource Gray600}"
                                       HorizontalTextAlignment="Center" />
                            </StackLayout>

                            <!-- Expertise Level -->
                            <StackLayout Grid.Row="1" Grid.Column="0" HorizontalOptions="Center">
                                <Label Text="{Binding ExpertiseLevelDisplay}"
                                       FontSize="16"
                                       FontAttributes="Bold"
                                       TextColor="{StaticResource Primary}"
                                       HorizontalTextAlignment="Center" />
                                <Label Text="Niveau d'Expertise"
                                       FontSize="12"
                                       TextColor="{StaticResource Gray600}"
                                       HorizontalTextAlignment="Center" />
                            </StackLayout>

                            <!-- Days Active -->
                            <StackLayout Grid.Row="1" Grid.Column="1" HorizontalOptions="Center">
                                <Label Text="{Binding UserStats.DaysActive}"
                                       FontSize="16"
                                       FontAttributes="Bold"
                                       TextColor="{StaticResource Info}"
                                       HorizontalTextAlignment="Center" />
                                <Label Text="Jours Actif"
                                       FontSize="12"
                                       TextColor="{StaticResource Gray600}"
                                       HorizontalTextAlignment="Center" />
                            </StackLayout>

                            <!-- Favorite Spot Type -->
                            <StackLayout Grid.Row="2" Grid.ColumnSpan="2" HorizontalOptions="Center" IsVisible="{Binding HasSpotsByType}">
                                <Label Text="{Binding UserStats.FavoriteSpotType}"
                                       FontSize="16"
                                       FontAttributes="Bold"
                                       TextColor="{StaticResource Primary}"
                                       HorizontalTextAlignment="Center" />
                                <Label Text="Type de Spot Favori"
                                       FontSize="12"
                                       TextColor="{StaticResource Gray600}"
                                       HorizontalTextAlignment="Center" />
                            </StackLayout>
                        </Grid>
                    </StackLayout>
                </Frame>

                <!-- Activity Timeline -->
                <Frame BackgroundColor="{StaticResource Gray100}" HasShadow="True" CornerRadius="12">
                    <StackLayout Spacing="16">
                        <Label Text="Chronologie d'Activité" 
                               FontSize="18" 
                               FontAttributes="Bold" 
                               TextColor="{StaticResource Primary}" />

                        <Grid RowDefinitions="Auto,Auto" ColumnDefinitions="*,*">
                            <!-- Last Activity -->
                            <StackLayout Grid.Row="0" Grid.Column="0" HorizontalOptions="Center">
                                <Label Text="{Binding LastActivityDisplay}"
                                       FontSize="14"
                                       FontAttributes="Bold"
                                       TextColor="{StaticResource Primary}"
                                       HorizontalTextAlignment="Center" />
                                <Label Text="Dernière Activité"
                                       FontSize="12"
                                       TextColor="{StaticResource Gray600}"
                                       HorizontalTextAlignment="Center" />
                            </StackLayout>

                            <!-- Last Spot Created -->
                            <StackLayout Grid.Row="0" Grid.Column="1" HorizontalOptions="Center">
                                <Label Text="{Binding LastSpotCreatedDisplay}"
                                       FontSize="14"
                                       FontAttributes="Bold"
                                       TextColor="{StaticResource Success}"
                                       HorizontalTextAlignment="Center" />
                                <Label Text="Dernier Spot Créé"
                                       FontSize="12"
                                       TextColor="{StaticResource Gray600}"
                                       HorizontalTextAlignment="Center" />
                            </StackLayout>
                        </Grid>
                    </StackLayout>
                </Frame>

                <!-- Certifications -->
                <Frame BackgroundColor="{StaticResource Gray100}" HasShadow="True" CornerRadius="12" IsVisible="{Binding HasCertifications}">
                    <StackLayout Spacing="16">
                        <Label Text="Certifications Récentes" 
                               FontSize="18" 
                               FontAttributes="Bold" 
                               TextColor="{StaticResource Primary}" />

                        <CollectionView ItemsSource="{Binding UserStats.RecentCertifications}">
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <Grid Padding="8">
                                        <Frame BackgroundColor="White" HasShadow="False" CornerRadius="8" Padding="12">
                                            <Label Text="{Binding .}" 
                                                   FontSize="14" 
                                                   TextColor="{StaticResource Primary}" 
                                                   HorizontalTextAlignment="Center" />
                                        </Frame>
                                    </Grid>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </StackLayout>
                </Frame>

                <!-- Back Button -->
                <Button Text="Retour" 
                        Command="{Binding GoBackCommand}"
                        BackgroundColor="{StaticResource Primary}"
                        TextColor="White"
                        HorizontalOptions="Center"
                        WidthRequest="120" />
            </StackLayout>
        </StackLayout>
    </ScrollView>
</ContentPage>