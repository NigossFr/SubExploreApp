<?xml version="1.0" encoding="utf-8" ?>
<ContentPage x:Class="SubExplore.Views.Profile.UserProfilePage"
             xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:SubExplore.ViewModels.Profile"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             x:DataType="vm:UserProfileViewModel"
             Title="{Binding Title}">

    <ContentPage.Resources>
        <ResourceDictionary>
            <toolkit:InvertedBoolConverter x:Key="InvertBoolConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <ScrollView Padding="0">
        <StackLayout Padding="16" Spacing="16">
            
            <!-- Loading & Error States -->
            <Grid IsVisible="{Binding IsLoading}" Padding="0,40">
                <StackLayout HorizontalOptions="Center" Spacing="16">
                    <ActivityIndicator IsRunning="{Binding IsLoading}"
                                     Color="{StaticResource Primary}"
                                     WidthRequest="48" 
                                     HeightRequest="48" />
                    <Label Text="Chargement de votre profil..."
                           FontSize="16"
                           TextColor="{StaticResource Gray600}"
                           HorizontalTextAlignment="Center"
                           LineHeight="1.4" />
                </StackLayout>
            </Grid>

            <!-- Error State with Action -->
            <Frame IsVisible="{Binding IsError}" 
                   BackgroundColor="{StaticResource Danger}" 
                   CornerRadius="12" 
                   Padding="16" 
                   HasShadow="False">
                <StackLayout Spacing="12">
                    <Label Text="âš ï¸ Erreur de chargement"
                           FontSize="18"
                           FontAttributes="Bold"
                           TextColor="White"
                           HorizontalTextAlignment="Center"
                           LineHeight="1.3" />
                    <Label Text="{Binding ErrorMessage}"
                           FontSize="15"
                           TextColor="White"
                           HorizontalTextAlignment="Center"
                           LineBreakMode="WordWrap"
                           LineHeight="1.5" />
                    <Button Text="RÃ©essayer"
                            Command="{Binding RefreshCommand}"
                            BackgroundColor="White"
                            TextColor="{StaticResource Danger}"
                            CornerRadius="8"
                            Padding="16,8"
                            HorizontalOptions="Center" />
                </StackLayout>
            </Frame>

            <!-- Profile Content -->
            <StackLayout IsVisible="{Binding IsLoading, Converter={StaticResource InvertBoolConverter}}" Spacing="16">
                
                <!-- Enhanced Profile Header -->
                <Frame BackgroundColor="{StaticResource Primary}" 
                       HasShadow="True" 
                       CornerRadius="20" 
                       Padding="24" 
                       Margin="0,8,0,8">
                    <Frame.Shadow>
                        <Shadow Brush="Black" Opacity="0.1" Radius="8" Offset="0,4" />
                    </Frame.Shadow>
                    <Grid RowDefinitions="Auto,Auto,Auto,Auto" ColumnDefinitions="Auto,*,Auto" ColumnSpacing="16">
                        
                        <!-- Enhanced Avatar with Touch Feedback -->
                        <Grid Grid.RowSpan="4" Grid.Column="0" WidthRequest="80" HeightRequest="80">
                            <Frame BackgroundColor="White" 
                                   CornerRadius="40" 
                                   HasShadow="True"
                                   Padding="2"
                                   HorizontalOptions="Fill"
                                   VerticalOptions="Fill">
                                <Frame.Shadow>
                                    <Shadow Brush="Black" Opacity="0.15" Radius="4" Offset="0,2" />
                                </Frame.Shadow>
                                <Border BackgroundColor="Transparent"
                                        StrokeThickness="0"
                                        WidthRequest="76"
                                        HeightRequest="76">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="38" />
                                    </Border.StrokeShape>
                                    <Image Source="{Binding AvatarUrl}" 
                                           Aspect="AspectFill">
                                        <Image.GestureRecognizers>
                                            <TapGestureRecognizer Command="{Binding ChangeAvatarCommand}" />
                                        </Image.GestureRecognizers>
                                    </Image>
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding ChangeAvatarCommand}" />
                                    </Border.GestureRecognizers>
                                </Border>
                            </Frame>
                            
                            <!-- Enhanced Verification Badge -->
                            <Frame BackgroundColor="{StaticResource Success}"
                                   CornerRadius="10"
                                   HasShadow="True"
                                   Padding="3"
                                   WidthRequest="20"
                                   HeightRequest="20"
                                   HorizontalOptions="End"
                                   VerticalOptions="End"
                                   Margin="0,0,-2,-2"
                                   IsVisible="{Binding CurrentUser.IsEmailConfirmed}">
                                <Frame.Shadow>
                                    <Shadow Brush="Black" Opacity="0.2" Radius="2" Offset="0,1" />
                                </Frame.Shadow>
                                <Label Text="âœ“"
                                       FontSize="12"
                                       FontAttributes="Bold"
                                       TextColor="White"
                                       HorizontalOptions="Center"
                                       VerticalOptions="Center" />
                            </Frame>
                            
                            <!-- Camera Overlay Hint -->
                            <Frame BackgroundColor="Black"
                                   Opacity="0.7"
                                   CornerRadius="40"
                                   HasShadow="False"
                                   Padding="0"
                                   HorizontalOptions="Fill"
                                   VerticalOptions="Fill"
                                   IsVisible="False"
                                   x:Name="CameraOverlay">
                                <Label Text="ðŸ“·"
                                       FontSize="24"
                                       TextColor="White"
                                       HorizontalOptions="Center"
                                       VerticalOptions="Center" />
                            </Frame>
                        </Grid>
                        
                        <!-- Enhanced Name and Badges Section -->
                        <StackLayout Grid.Row="0" Grid.Column="1" Spacing="4">
                            <StackLayout Orientation="Horizontal" Spacing="8">
                                <Label Text="{Binding DisplayName}"
                                       FontSize="22"
                                       FontAttributes="Bold"
                                       TextColor="White"
                                       VerticalOptions="Center"
                                       LineBreakMode="TailTruncation"
                                       MaxLines="1"
                                       LineHeight="1.2" />
                                
                                <!-- Enhanced Account type badge -->
                                <Frame BackgroundColor="{StaticResource Secondary}"
                                       CornerRadius="8"
                                       HasShadow="True"
                                       Padding="6,3"
                                       VerticalOptions="Center"
                                       IsVisible="{Binding ShowAccountTypeBadge}">
                                    <Frame.Shadow>
                                        <Shadow Brush="Black" Opacity="0.15" Radius="2" Offset="0,1" />
                                    </Frame.Shadow>
                                    <Label Text="{Binding AccountTypeDisplay}"
                                           FontSize="10"
                                           FontAttributes="Bold"
                                           TextColor="White" />
                                </Frame>
                            </StackLayout>
                        </StackLayout>
                        
                        <StackLayout Grid.Row="1" Grid.Column="1" Orientation="Horizontal" Spacing="6" Margin="0,2,0,0">
                            <Label FontSize="13"
                                   TextColor="White"
                                   Opacity="0.8"
                                   LineBreakMode="TailTruncation">
                                <Label.FormattedText>
                                    <FormattedString>
                                        <Span Text="@" />
                                        <Span Text="{Binding CurrentUser.Username}" />
                                    </FormattedString>
                                </Label.FormattedText>
                            </Label>
                            
                            <!-- Expertise Level -->
                            <Label FontSize="11"
                                   TextColor="White"
                                   Opacity="0.8"
                                   IsVisible="{Binding CurrentUser.ExpertiseLevel, Converter={toolkit:IsNotNullConverter}}">
                                <Label.FormattedText>
                                    <FormattedString>
                                        <Span Text="â€¢ " />
                                        <Span Text="{Binding ExpertiseLevelDisplay}" />
                                    </FormattedString>
                                </Label.FormattedText>
                            </Label>
                        </StackLayout>
                        
                        <!-- Member Since -->
                        <Label Grid.Row="2" Grid.Column="1" 
                               FontSize="11"
                               TextColor="White"
                               Opacity="0.7"
                               Margin="0,2,0,0"
                               LineBreakMode="TailTruncation">
                            <Label.FormattedText>
                                <FormattedString>
                                    <Span Text="ðŸ“… Member since " />
                                    <Span Text="{Binding MemberSince}" />
                                </FormattedString>
                            </Label.FormattedText>
                        </Label>
                        
                        <!-- Last Login -->
                        <Label Grid.Row="3" Grid.Column="1" 
                               FontSize="10"
                               TextColor="White"
                               Opacity="0.6"
                               Margin="0,1,0,0"
                               LineBreakMode="TailTruncation"
                               IsVisible="{Binding CurrentUser.LastLogin, Converter={toolkit:IsNotNullConverter}}">
                            <Label.FormattedText>
                                <FormattedString>
                                    <Span Text="ðŸ”„ Last seen " />
                                    <Span Text="{Binding LastSeenDisplay}" />
                                </FormattedString>
                            </Label.FormattedText>
                        </Label>
                        
                        <!-- Enhanced Edit Button with Better Touch Target -->
                        <Button Grid.RowSpan="4" Grid.Column="2" 
                                Text="âœï¸"
                                Command="{Binding ToggleEditModeCommand}"
                                BackgroundColor="White"
                                TextColor="{StaticResource Primary}"
                                FontSize="16"
                                Padding="12"
                                CornerRadius="22"
                                WidthRequest="48"
                                HeightRequest="48"
                                VerticalOptions="Start"
                                IsVisible="{Binding IsEditMode, Converter={StaticResource InvertBoolConverter}}"
                                AutomationId="EditProfileButton"
                                SemanticProperties.Description="Modifier les informations de votre profil"
                                SemanticProperties.Hint="Appuyez deux fois pour passer en mode Ã©dition">
                            <Button.Shadow>
                                <Shadow Brush="Black" Opacity="0.15" Radius="4" Offset="0,2" />
                            </Button.Shadow>
                            <VisualStateManager.VisualStateGroups>
                                <VisualStateGroup Name="CommonStates">
                                    <VisualState Name="Normal">
                                        <VisualState.Setters>
                                            <Setter Property="Scale" Value="1" />
                                            <Setter Property="Opacity" Value="1" />
                                        </VisualState.Setters>
                                    </VisualState>
                                    <VisualState Name="Pressed">
                                        <VisualState.Setters>
                                            <Setter Property="Scale" Value="0.95" />
                                            <Setter Property="Opacity" Value="0.8" />
                                        </VisualState.Setters>
                                    </VisualState>
                                    <VisualState Name="Disabled">
                                        <VisualState.Setters>
                                            <Setter Property="Opacity" Value="0.5" />
                                        </VisualState.Setters>
                                    </VisualState>
                                </VisualStateGroup>
                            </VisualStateManager.VisualStateGroups>
                        </Button>
                    </Grid>
                </Frame>

                <!-- Enhanced Stats Section -->
                <Frame BackgroundColor="{StaticResource Gray100}" 
                       HasShadow="True" 
                       CornerRadius="20" 
                       IsVisible="{Binding HasStats}" 
                       Padding="20" 
                       Margin="0,4,0,8">
                    <Frame.Shadow>
                        <Shadow Brush="Black" Opacity="0.08" Radius="6" Offset="0,3" />
                    </Frame.Shadow>
                    <StackLayout Spacing="16">
                        <StackLayout Orientation="Horizontal" HorizontalOptions="Center" Spacing="8">
                            <Label Text="ðŸ“Š"
                                   FontSize="20"
                                   VerticalOptions="Center" />
                            <Label Text="Votre activitÃ©"
                                   FontSize="18"
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource Primary}"
                                   VerticalOptions="Center" />
                        </StackLayout>
                        
                        <Grid RowDefinitions="Auto,Auto" ColumnDefinitions="*,*,*" RowSpacing="12" ColumnSpacing="8">
                            
                            <!-- Enhanced Total Spots Card -->
                            <Frame Grid.Row="0" Grid.Column="0" 
                                   BackgroundColor="White" 
                                   CornerRadius="16" 
                                   Padding="16,12" 
                                   HasShadow="True"
                                   HorizontalOptions="Fill">
                                <Frame.Shadow>
                                    <Shadow Brush="Black" Opacity="0.06" Radius="4" Offset="0,2" />
                                </Frame.Shadow>
                                <Frame.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding ViewStatsCommand}" />
                                </Frame.GestureRecognizers>
                                <StackLayout HorizontalOptions="Center" Spacing="4">
                                    <Label Text="ðŸ“"
                                           FontSize="24"
                                           HorizontalTextAlignment="Center"
                                           SemanticProperties.Description="IcÃ´ne spots de plongÃ©e" />
                                    <Label Text="{Binding UserStats.TotalSpots}"
                                           FontSize="24"
                                           FontAttributes="Bold"
                                           TextColor="{StaticResource Primary}"
                                           HorizontalTextAlignment="Center"
                                           AutomationId="TotalSpotsCount"
                                           SemanticProperties.Description="Nombre total de spots crÃ©Ã©s" />
                                    <Label Text="Spots"
                                           FontSize="12"
                                           TextColor="{StaticResource Gray600}"
                                           HorizontalTextAlignment="Center" />
                                </StackLayout>
                                <VisualStateManager.VisualStateGroups>
                                    <VisualStateGroup Name="CommonStates">
                                        <VisualState Name="Normal">
                                            <VisualState.Setters>
                                                <Setter Property="Scale" Value="1" />
                                            </VisualState.Setters>
                                        </VisualState>
                                        <VisualState Name="Pressed">
                                            <VisualState.Setters>
                                                <Setter Property="Scale" Value="0.97" />
                                            </VisualState.Setters>
                                        </VisualState>
                                    </VisualStateGroup>
                                </VisualStateManager.VisualStateGroups>
                            </Frame>

                            <!-- Enhanced Validated Spots Card -->
                            <Frame Grid.Row="0" Grid.Column="1" 
                                   BackgroundColor="White" 
                                   CornerRadius="16" 
                                   Padding="16,12" 
                                   HasShadow="True"
                                   HorizontalOptions="Fill">
                                <Frame.Shadow>
                                    <Shadow Brush="Black" Opacity="0.06" Radius="4" Offset="0,2" />
                                </Frame.Shadow>
                                <Frame.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding ViewStatsCommand}" />
                                </Frame.GestureRecognizers>
                                <StackLayout HorizontalOptions="Center" Spacing="4">
                                    <Label Text="âœ…"
                                           FontSize="24"
                                           HorizontalTextAlignment="Center"
                                           SemanticProperties.Description="IcÃ´ne spots validÃ©s" />
                                    <Label Text="{Binding UserStats.ValidatedSpots}"
                                           FontSize="24"
                                           FontAttributes="Bold"
                                           TextColor="{StaticResource Success}"
                                           HorizontalTextAlignment="Center"
                                           AutomationId="ValidatedSpotsCount"
                                           SemanticProperties.Description="Nombre de spots validÃ©s par la communautÃ©" />
                                    <Label Text="ValidÃ©s"
                                           FontSize="12"
                                           TextColor="{StaticResource Gray600}"
                                           HorizontalTextAlignment="Center" />
                                </StackLayout>
                                <VisualStateManager.VisualStateGroups>
                                    <VisualStateGroup Name="CommonStates">
                                        <VisualState Name="Normal">
                                            <VisualState.Setters>
                                                <Setter Property="Scale" Value="1" />
                                            </VisualState.Setters>
                                        </VisualState>
                                        <VisualState Name="Pressed">
                                            <VisualState.Setters>
                                                <Setter Property="Scale" Value="0.97" />
                                            </VisualState.Setters>
                                        </VisualState>
                                    </VisualStateGroup>
                                </VisualStateManager.VisualStateGroups>
                            </Frame>

                            <!-- Enhanced Contribution Score Card -->
                            <Frame Grid.Row="0" Grid.Column="2" 
                                   BackgroundColor="White" 
                                   CornerRadius="16" 
                                   Padding="16,12" 
                                   HasShadow="True"
                                   HorizontalOptions="Fill">
                                <Frame.Shadow>
                                    <Shadow Brush="Black" Opacity="0.06" Radius="4" Offset="0,2" />
                                </Frame.Shadow>
                                <Frame.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding ViewStatsCommand}" />
                                </Frame.GestureRecognizers>
                                <StackLayout HorizontalOptions="Center" Spacing="4">
                                    <Label Text="â­"
                                           FontSize="24"
                                           HorizontalTextAlignment="Center"
                                           SemanticProperties.Description="IcÃ´ne score de contribution" />
                                    <Label Text="{Binding UserStats.ContributionScore}"
                                           FontSize="24"
                                           FontAttributes="Bold"
                                           TextColor="{StaticResource Warning}"
                                           HorizontalTextAlignment="Center"
                                           AutomationId="ContributionScore"
                                           SemanticProperties.Description="Votre score de contribution Ã  la communautÃ©" />
                                    <Label Text="Points"
                                           FontSize="12"
                                           TextColor="{StaticResource Gray600}"
                                           HorizontalTextAlignment="Center" />
                                </StackLayout>
                                <VisualStateManager.VisualStateGroups>
                                    <VisualStateGroup Name="CommonStates">
                                        <VisualState Name="Normal">
                                            <VisualState.Setters>
                                                <Setter Property="Scale" Value="1" />
                                            </VisualState.Setters>
                                        </VisualState>
                                        <VisualState Name="Pressed">
                                            <VisualState.Setters>
                                                <Setter Property="Scale" Value="0.97" />
                                            </VisualState.Setters>
                                        </VisualState>
                                    </VisualStateGroup>
                                </VisualStateManager.VisualStateGroups>
                            </Frame>

                            <!-- Enhanced Contribution Level Badge -->
                            <Frame Grid.Row="1" Grid.ColumnSpan="3" 
                                   BackgroundColor="{StaticResource Primary}"
                                   CornerRadius="16"
                                   HasShadow="True"
                                   Padding="16,8"
                                   Margin="8,8,8,0"
                                   HorizontalOptions="Center">
                                <Frame.Shadow>
                                    <Shadow Brush="Black" Opacity="0.12" Radius="4" Offset="0,2" />
                                </Frame.Shadow>
                                <StackLayout Orientation="Horizontal" Spacing="8" HorizontalOptions="Center">
                                    <Label Text="ðŸ†"
                                           FontSize="16"
                                           VerticalOptions="Center" />
                                    <Label Text="{Binding ContributionLevel}"
                                           FontSize="14"
                                           FontAttributes="Bold"
                                           TextColor="White"
                                           VerticalOptions="Center" />
                                </StackLayout>
                            </Frame>
                        </Grid>
                    </StackLayout>
                </Frame>

                <!-- Edit Mode Form -->
                <Frame BackgroundColor="{StaticResource Gray100}" HasShadow="True" CornerRadius="15" IsVisible="{Binding IsEditMode}" Padding="18" Margin="0,0,0,5">
                    <StackLayout Spacing="16">
                        <Label Text="âœï¸ Modifier le profil" 
                               FontSize="18" 
                               FontAttributes="Bold" 
                               TextColor="{StaticResource Primary}" />

                        <!-- Validation Message -->
                        <Label Text="{Binding ValidationMessage}"
                               TextColor="Red"
                               FontSize="14"
                               IsVisible="{Binding ValidationMessage, Converter={toolkit:IsStringNotNullOrEmptyConverter}}" />

                        <!-- First Name -->
                        <StackLayout>
                            <Label Text="PrÃ©nom" FontSize="14" TextColor="{StaticResource Gray600}" />
                            <Entry Text="{Binding FirstName}" 
                                   BackgroundColor="White" 
                                   IsEnabled="{Binding IsUpdating, Converter={StaticResource InvertBoolConverter}}" />
                        </StackLayout>

                        <!-- Last Name -->
                        <StackLayout>
                            <Label Text="Nom de famille" FontSize="14" TextColor="{StaticResource Gray600}" />
                            <Entry Text="{Binding LastName}" 
                                   BackgroundColor="White" 
                                   IsEnabled="{Binding IsUpdating, Converter={StaticResource InvertBoolConverter}}" />
                        </StackLayout>

                        <!-- Username -->
                        <StackLayout>
                            <Label Text="Nom d'utilisateur" FontSize="14" TextColor="{StaticResource Gray600}" />
                            <Entry Text="{Binding Username}" 
                                   BackgroundColor="White" 
                                   IsEnabled="{Binding IsUpdating, Converter={StaticResource InvertBoolConverter}}" />
                        </StackLayout>

                        <!-- Email -->
                        <StackLayout>
                            <Label Text="Email" FontSize="14" TextColor="{StaticResource Gray600}" />
                            <Entry Text="{Binding Email}" 
                                   Keyboard="Email" 
                                   BackgroundColor="White" 
                                   IsEnabled="{Binding IsUpdating, Converter={StaticResource InvertBoolConverter}}" />
                        </StackLayout>

                        <!-- Expertise Level -->
                        <StackLayout>
                            <Label Text="Niveau d'expertise" FontSize="14" TextColor="{StaticResource Gray600}" />
                            <Picker ItemsSource="{Binding ExpertiseLevel}" 
                                    SelectedItem="{Binding ExpertiseLevel}" 
                                    BackgroundColor="White"
                                    IsEnabled="{Binding IsUpdating, Converter={StaticResource InvertBoolConverter}}" />
                        </StackLayout>

                        <!-- Buttons -->
                        <StackLayout Orientation="Horizontal" HorizontalOptions="Center" Spacing="16">
                            <Button Text="Annuler" 
                                    Command="{Binding ToggleEditModeCommand}"
                                    BackgroundColor="{StaticResource Gray300}"
                                    TextColor="Black"
                                    IsEnabled="{Binding IsUpdating, Converter={StaticResource InvertBoolConverter}}" />
                            
                            <Button Text="Enregistrer" 
                                    Command="{Binding SaveProfileCommand}"
                                    BackgroundColor="{StaticResource Primary}"
                                    TextColor="White"
                                    IsEnabled="{Binding IsUpdating, Converter={StaticResource InvertBoolConverter}}" />
                        </StackLayout>

                        <!-- Updating Indicator -->
                        <ActivityIndicator IsVisible="{Binding IsUpdating}" 
                                         IsRunning="{Binding IsUpdating}"
                                         Color="{StaticResource Primary}"
                                         HorizontalOptions="Center" />
                    </StackLayout>
                </Frame>

                <!-- Certifications Section -->
                <Frame BackgroundColor="{StaticResource Gray100}" HasShadow="True" CornerRadius="15" 
                       IsVisible="{Binding HasCertifications}" Padding="18" Margin="0,0,0,5">
                    <StackLayout Spacing="10">
                        <Label Text="ðŸ… Certifications"
                               FontSize="15"
                               FontAttributes="Bold"
                               TextColor="{StaticResource Primary}" />
                        
                        <CollectionView ItemsSource="{Binding CertificationsList}"
                                        SelectionMode="None">
                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="vm:CertificationItem">
                                    <Grid ColumnDefinitions="Auto,*,Auto" 
                                          Padding="6,3"
                                          ColumnSpacing="8">
                                        <Label Grid.Column="0"
                                               Text="ðŸ…"
                                               FontSize="14"
                                               VerticalOptions="Center" />
                                        <StackLayout Grid.Column="1" Spacing="1">
                                            <Label Text="{Binding Type}"
                                                   FontSize="13"
                                                   FontAttributes="Bold"
                                                   TextColor="{StaticResource TextPrimary}"
                                                   LineBreakMode="TailTruncation" />
                                            <Label Text="{Binding Level}"
                                                   FontSize="11"
                                                   TextColor="{StaticResource Gray600}"
                                                   LineBreakMode="TailTruncation" />
                                        </StackLayout>
                                        <Label Grid.Column="2"
                                               Text="{Binding Date, StringFormat='{0:MMM yyyy}'}"
                                               FontSize="10"
                                               TextColor="{StaticResource Gray500}"
                                               VerticalOptions="Center" />
                                    </Grid>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </StackLayout>
                </Frame>

                <!-- Enhanced Account Information Section -->
                <Frame BackgroundColor="White" 
                       HasShadow="True" 
                       CornerRadius="20" 
                       Padding="20" 
                       Margin="0,4,0,8" 
                       IsVisible="{Binding IsEditMode, Converter={StaticResource InvertBoolConverter}}">
                    <Frame.Shadow>
                        <Shadow Brush="Black" Opacity="0.08" Radius="6" Offset="0,3" />
                    </Frame.Shadow>
                    <StackLayout Spacing="16">
                        <!-- Enhanced Section Header -->
                        <StackLayout Orientation="Horizontal" Spacing="12">
                            <Frame BackgroundColor="{StaticResource Primary}"
                                   CornerRadius="12"
                                   HasShadow="False"
                                   Padding="8"
                                   WidthRequest="40"
                                   HeightRequest="40"
                                   VerticalOptions="Center">
                                <Label Text="ðŸ“§"
                                       FontSize="20"
                                       TextColor="White"
                                       HorizontalOptions="Center"
                                       VerticalOptions="Center" />
                            </Frame>
                            <StackLayout VerticalOptions="Center">
                                <Label Text="Informations du compte"
                                       FontSize="18"
                                       FontAttributes="Bold"
                                       TextColor="{StaticResource Primary}" />
                                <Label Text="GÃ©rez vos informations personnelles"
                                       FontSize="12"
                                       TextColor="{StaticResource Gray600}" />
                            </StackLayout>
                        </StackLayout>
                        
                        <!-- Enhanced Email Display Card -->
                        <Frame BackgroundColor="{StaticResource Gray100}"
                               CornerRadius="16"
                               HasShadow="False"
                               Padding="16">
                            <StackLayout Spacing="8">
                                <StackLayout Orientation="Horizontal" Spacing="12">
                                    <Label Text="âœ‰ï¸"
                                           FontSize="16"
                                           VerticalOptions="Center" />
                                    <StackLayout HorizontalOptions="StartAndExpand">
                                        <Label Text="Adresse email"
                                               FontSize="12"
                                               TextColor="{StaticResource Gray600}" />
                                        <Label Text="{Binding CurrentUser.Email}"
                                               FontSize="16"
                                               FontAttributes="Bold"
                                               TextColor="{StaticResource TextPrimary}" />
                                    </StackLayout>
                                    <Frame BackgroundColor="{StaticResource Success}"
                                           CornerRadius="12"
                                           HasShadow="True"
                                           Padding="8,4"
                                           VerticalOptions="Center"
                                           IsVisible="{Binding CurrentUser.IsEmailConfirmed}">
                                        <Frame.Shadow>
                                            <Shadow Brush="Black" Opacity="0.1" Radius="2" Offset="0,1" />
                                        </Frame.Shadow>
                                        <StackLayout Orientation="Horizontal" Spacing="4">
                                            <Label Text="âœ“"
                                                   FontSize="12"
                                                   FontAttributes="Bold"
                                                   TextColor="White" />
                                            <Label Text="VÃ©rifiÃ©"
                                                   FontSize="12"
                                                   FontAttributes="Bold"
                                                   TextColor="White" />
                                        </StackLayout>
                                    </Frame>
                                </StackLayout>
                            </StackLayout>
                        </Frame>
                        
                        <!-- Enhanced Action Buttons -->
                        <Grid ColumnDefinitions="*,*" ColumnSpacing="12">
                            <!-- Enhanced Password Change Button -->
                            <Frame Grid.Column="0"
                                   BackgroundColor="{StaticResource Secondary}"
                                   CornerRadius="16"
                                   HasShadow="True"
                                   Padding="0">
                                <Frame.Shadow>
                                    <Shadow Brush="Black" Opacity="0.06" Radius="4" Offset="0,2" />
                                </Frame.Shadow>
                                <Button Text="ðŸ”’ Changer mot de passe"
                                        Command="{Binding ChangePasswordCommand}"
                                        BackgroundColor="Transparent"
                                        TextColor="White"
                                        FontSize="13"
                                        FontAttributes="Bold"
                                        Padding="16,12"
                                        CornerRadius="16"
                                        AutomationId="ChangePasswordButton"
                                        SemanticProperties.Description="Modifier votre mot de passe actuel"
                                        SemanticProperties.Hint="Appuyez deux fois pour changer votre mot de passe" />
                            </Frame>
                            
                            <!-- Enhanced Stats Button -->
                            <Frame Grid.Column="1"
                                   BackgroundColor="{StaticResource Primary}"
                                   CornerRadius="16"
                                   HasShadow="True"
                                   Padding="0"
                                   IsVisible="{Binding HasStats}">
                                <Frame.Shadow>
                                    <Shadow Brush="Black" Opacity="0.06" Radius="4" Offset="0,2" />
                                </Frame.Shadow>
                                <Button Text="ðŸ“Š Voir statistiques"
                                        Command="{Binding ViewStatsCommand}"
                                        BackgroundColor="Transparent"
                                        TextColor="White"
                                        FontSize="13"
                                        FontAttributes="Bold"
                                        Padding="16,12"
                                        CornerRadius="16"
                                        AutomationId="ViewStatsButton"
                                        SemanticProperties.Description="Consulter vos statistiques de plongÃ©e dÃ©taillÃ©es"
                                        SemanticProperties.Hint="Appuyez deux fois pour voir vos statistiques complÃ¨tes" />
                            </Frame>
                        </Grid>
                    </StackLayout>
                </Frame>

                <!-- Enhanced Appearance Preferences Section -->
                <Frame BackgroundColor="White" 
                       HasShadow="True" 
                       CornerRadius="20" 
                       Padding="20" 
                       Margin="0,4,0,8" 
                       IsVisible="{Binding IsEditMode, Converter={StaticResource InvertBoolConverter}}">
                    <Frame.Shadow>
                        <Shadow Brush="Black" Opacity="0.08" Radius="6" Offset="0,3" />
                    </Frame.Shadow>
                    <StackLayout Spacing="18">
                        <!-- Enhanced Section Header -->
                        <StackLayout Orientation="Horizontal" Spacing="12">
                            <Frame BackgroundColor="{StaticResource Warning}"
                                   CornerRadius="12"
                                   HasShadow="False"
                                   Padding="8"
                                   WidthRequest="40"
                                   HeightRequest="40"
                                   VerticalOptions="Center">
                                <Label Text="ðŸŽ¨"
                                       FontSize="20"
                                       TextColor="White"
                                       HorizontalOptions="Center"
                                       VerticalOptions="Center" />
                            </Frame>
                            <StackLayout VerticalOptions="Center">
                                <Label Text="PrÃ©fÃ©rences d'apparence"
                                       FontSize="18"
                                       FontAttributes="Bold"
                                       TextColor="{StaticResource Primary}" />
                                <Label Text="Personnalisez votre interface"
                                       FontSize="12"
                                       TextColor="{StaticResource Gray600}" />
                            </StackLayout>
                        </StackLayout>

                        <!-- Enhanced Theme Selection -->
                        <Frame BackgroundColor="{StaticResource Gray100}"
                               CornerRadius="16"
                               HasShadow="False"
                               Padding="16">
                            <StackLayout Spacing="8">
                                <StackLayout Orientation="Horizontal" Spacing="8">
                                    <Label Text="ðŸŒ“"
                                           FontSize="16"
                                           VerticalOptions="Center" />
                                    <Label Text="ThÃ¨me"
                                           FontSize="14"
                                           FontAttributes="Bold"
                                           TextColor="{StaticResource TextPrimary}"
                                           VerticalOptions="Center" />
                                </StackLayout>
                                <Frame BackgroundColor="White"
                                       CornerRadius="12"
                                       HasShadow="True"
                                       Padding="0">
                                    <Frame.Shadow>
                                        <Shadow Brush="Black" Opacity="0.06" Radius="2" Offset="0,1" />
                                    </Frame.Shadow>
                                    <Picker ItemsSource="{Binding ThemeOptionsDisplay}" 
                                            SelectedIndex="{Binding SelectedThemeIndex}" 
                                            BackgroundColor="Transparent"
                                            FontSize="14"
                                            Margin="12,8"
                                            AutomationId="ThemePicker"
                                            SemanticProperties.Description="SÃ©lectionner le thÃ¨me d'affichage"
                                            SemanticProperties.Hint="Appuyez pour choisir entre thÃ¨me clair, sombre ou automatique" />
                                </Frame>
                            </StackLayout>
                        </Frame>

                        <!-- Enhanced Language Selection -->
                        <Frame BackgroundColor="{StaticResource Gray100}"
                               CornerRadius="16"
                               HasShadow="False"
                               Padding="16">
                            <StackLayout Spacing="8">
                                <StackLayout Orientation="Horizontal" Spacing="8">
                                    <Label Text="ðŸŒ"
                                           FontSize="16"
                                           VerticalOptions="Center" />
                                    <Label Text="Langue"
                                           FontSize="14"
                                           FontAttributes="Bold"
                                           TextColor="{StaticResource TextPrimary}"
                                           VerticalOptions="Center" />
                                </StackLayout>
                                <Frame BackgroundColor="White"
                                       CornerRadius="12"
                                       HasShadow="True"
                                       Padding="0">
                                    <Frame.Shadow>
                                        <Shadow Brush="Black" Opacity="0.06" Radius="2" Offset="0,1" />
                                    </Frame.Shadow>
                                    <Picker ItemsSource="{Binding LanguageOptionsDisplay}" 
                                            SelectedIndex="{Binding SelectedLanguageIndex}" 
                                            BackgroundColor="Transparent"
                                            FontSize="14"
                                            Margin="12,8"
                                            AutomationId="LanguagePicker"
                                            SemanticProperties.Description="SÃ©lectionner la langue de l'interface"
                                            SemanticProperties.Hint="Appuyez pour choisir votre langue prÃ©fÃ©rÃ©e" />
                                </Frame>
                            </StackLayout>
                        </Frame>

                        <!-- Enhanced Display Name Selection -->
                        <Frame BackgroundColor="{StaticResource Gray100}"
                               CornerRadius="16"
                               HasShadow="False"
                               Padding="16">
                            <StackLayout Spacing="8">
                                <StackLayout Orientation="Horizontal" Spacing="8">
                                    <Label Text="ðŸ“"
                                           FontSize="16"
                                           VerticalOptions="Center" />
                                    <Label Text="Affichage du nom"
                                           FontSize="14"
                                           FontAttributes="Bold"
                                           TextColor="{StaticResource TextPrimary}"
                                           VerticalOptions="Center" />
                                </StackLayout>
                                <Frame BackgroundColor="White"
                                       CornerRadius="12"
                                       HasShadow="True"
                                       Padding="0">
                                    <Frame.Shadow>
                                        <Shadow Brush="Black" Opacity="0.06" Radius="2" Offset="0,1" />
                                    </Frame.Shadow>
                                    <Picker ItemsSource="{Binding DisplayNameOptionsDisplay}" 
                                            SelectedIndex="{Binding SelectedDisplayNameIndex}" 
                                            BackgroundColor="Transparent"
                                            FontSize="14"
                                            Margin="12,8"
                                            AutomationId="DisplayNamePicker"
                                            SemanticProperties.Description="Choisir comment afficher votre nom"
                                            SemanticProperties.Hint="Appuyez pour sÃ©lectionner le format d'affichage de votre nom" />
                                </Frame>
                            </StackLayout>
                        </Frame>
                    </StackLayout>
                </Frame>

                <!-- Enhanced Notification Preferences Section -->
                <Frame BackgroundColor="White" 
                       HasShadow="True" 
                       CornerRadius="20" 
                       Padding="20" 
                       Margin="0,4,0,8" 
                       IsVisible="{Binding IsEditMode, Converter={StaticResource InvertBoolConverter}}">
                    <Frame.Shadow>
                        <Shadow Brush="Black" Opacity="0.08" Radius="6" Offset="0,3" />
                    </Frame.Shadow>
                    <StackLayout Spacing="18">
                        <!-- Enhanced Section Header -->
                        <StackLayout Orientation="Horizontal" Spacing="12">
                            <Frame BackgroundColor="{StaticResource Info}"
                                   CornerRadius="12"
                                   HasShadow="False"
                                   Padding="8"
                                   WidthRequest="40"
                                   HeightRequest="40"
                                   VerticalOptions="Center">
                                <Label Text="ðŸ””"
                                       FontSize="20"
                                       TextColor="White"
                                       HorizontalOptions="Center"
                                       VerticalOptions="Center" />
                            </Frame>
                            <StackLayout VerticalOptions="Center">
                                <Label Text="Notifications"
                                       FontSize="18"
                                       FontAttributes="Bold"
                                       TextColor="{StaticResource Primary}" />
                                <Label Text="ContrÃ´lez vos notifications"
                                       FontSize="12"
                                       TextColor="{StaticResource Gray600}" />
                            </StackLayout>
                        </StackLayout>

                        <!-- Enhanced Notification Settings -->
                        <StackLayout Spacing="12">
                            <!-- Push Notifications -->
                            <Frame BackgroundColor="{StaticResource Gray100}"
                                   CornerRadius="16"
                                   HasShadow="False"
                                   Padding="16">
                                <StackLayout Orientation="Horizontal" Spacing="12">
                                    <Frame BackgroundColor="{StaticResource Primary}"
                                           CornerRadius="10"
                                           HasShadow="False"
                                           Padding="6"
                                           WidthRequest="32"
                                           HeightRequest="32"
                                           VerticalOptions="Center">
                                        <Label Text="ðŸ“±"
                                               FontSize="14"
                                               TextColor="White"
                                               HorizontalOptions="Center"
                                               VerticalOptions="Center" />
                                    </Frame>
                                    <StackLayout HorizontalOptions="StartAndExpand" VerticalOptions="Center">
                                        <Label Text="Notifications push"
                                               FontSize="14"
                                               FontAttributes="Bold"
                                               TextColor="{StaticResource TextPrimary}" />
                                        <Label Text="Recevez des alertes sur votre appareil"
                                               FontSize="12"
                                               TextColor="{StaticResource Gray600}" />
                                    </StackLayout>
                                    <Switch IsToggled="{Binding PushNotifications}" 
                                            OnColor="{StaticResource Primary}"
                                            VerticalOptions="Center"
                                            AutomationId="PushNotificationsSwitch"
                                            SemanticProperties.Description="Activer ou dÃ©sactiver les notifications push"
                                            SemanticProperties.Hint="Basculez pour modifier ce paramÃ¨tre" />
                                </StackLayout>
                            </Frame>

                            <!-- Email Notifications -->
                            <Frame BackgroundColor="{StaticResource Gray100}"
                                   CornerRadius="16"
                                   HasShadow="False"
                                   Padding="16">
                                <StackLayout Orientation="Horizontal" Spacing="12">
                                    <Frame BackgroundColor="{StaticResource Secondary}"
                                           CornerRadius="10"
                                           HasShadow="False"
                                           Padding="6"
                                           WidthRequest="32"
                                           HeightRequest="32"
                                           VerticalOptions="Center">
                                        <Label Text="ðŸ“§"
                                               FontSize="14"
                                               TextColor="White"
                                               HorizontalOptions="Center"
                                               VerticalOptions="Center" />
                                    </Frame>
                                    <StackLayout HorizontalOptions="StartAndExpand" VerticalOptions="Center">
                                        <Label Text="Notifications par email"
                                               FontSize="14"
                                               FontAttributes="Bold"
                                               TextColor="{StaticResource TextPrimary}" />
                                        <Label Text="Recevez des rÃ©sumÃ©s par email"
                                               FontSize="12"
                                               TextColor="{StaticResource Gray600}" />
                                    </StackLayout>
                                    <Switch IsToggled="{Binding EmailNotifications}" 
                                            OnColor="{StaticResource Primary}"
                                            VerticalOptions="Center"
                                            AutomationId="EmailNotificationsSwitch"
                                            SemanticProperties.Description="Activer ou dÃ©sactiver les notifications par email"
                                            SemanticProperties.Hint="Basculez pour modifier ce paramÃ¨tre" />
                                </StackLayout>
                            </Frame>

                            <!-- Nearby Spots -->
                            <Frame BackgroundColor="{StaticResource Gray100}"
                                   CornerRadius="16"
                                   HasShadow="False"
                                   Padding="16">
                                <StackLayout Orientation="Horizontal" Spacing="12">
                                    <Frame BackgroundColor="{StaticResource Success}"
                                           CornerRadius="10"
                                           HasShadow="False"
                                           Padding="6"
                                           WidthRequest="32"
                                           HeightRequest="32"
                                           VerticalOptions="Center">
                                        <Label Text="ðŸ“"
                                               FontSize="14"
                                               TextColor="White"
                                               HorizontalOptions="Center"
                                               VerticalOptions="Center" />
                                    </Frame>
                                    <StackLayout HorizontalOptions="StartAndExpand" VerticalOptions="Center">
                                        <Label Text="Nouveaux spots Ã  proximitÃ©"
                                               FontSize="14"
                                               FontAttributes="Bold"
                                               TextColor="{StaticResource TextPrimary}" />
                                        <Label Text="DÃ©couvrez les spots prÃ¨s de vous"
                                               FontSize="12"
                                               TextColor="{StaticResource Gray600}" />
                                    </StackLayout>
                                    <Switch IsToggled="{Binding SpotsNearby}" 
                                            OnColor="{StaticResource Primary}"
                                            VerticalOptions="Center"
                                            AutomationId="SpotsNearbySwitch"
                                            SemanticProperties.Description="Recevoir des notifications pour les nouveaux spots Ã  proximitÃ©"
                                            SemanticProperties.Hint="Basculez pour modifier ce paramÃ¨tre" />
                                </StackLayout>
                            </Frame>

                            <!-- Community Updates -->
                            <Frame BackgroundColor="{StaticResource Gray100}"
                                   CornerRadius="16"
                                   HasShadow="False"
                                   Padding="16">
                                <StackLayout Orientation="Horizontal" Spacing="12">
                                    <Frame BackgroundColor="{StaticResource Warning}"
                                           CornerRadius="10"
                                           HasShadow="False"
                                           Padding="6"
                                           WidthRequest="32"
                                           HeightRequest="32"
                                           VerticalOptions="Center">
                                        <Label Text="ðŸ‘¥"
                                               FontSize="14"
                                               TextColor="White"
                                               HorizontalOptions="Center"
                                               VerticalOptions="Center" />
                                    </Frame>
                                    <StackLayout HorizontalOptions="StartAndExpand" VerticalOptions="Center">
                                        <Label Text="ActualitÃ©s de la communautÃ©"
                                               FontSize="14"
                                               FontAttributes="Bold"
                                               TextColor="{StaticResource TextPrimary}" />
                                        <Label Text="Restez informÃ© des nouvelles"
                                               FontSize="12"
                                               TextColor="{StaticResource Gray600}" />
                                    </StackLayout>
                                    <Switch IsToggled="{Binding CommunityUpdates}" 
                                            OnColor="{StaticResource Primary}"
                                            VerticalOptions="Center"
                                            AutomationId="CommunityUpdatesSwitch"
                                            SemanticProperties.Description="Recevoir les actualitÃ©s de la communautÃ© SubExplore"
                                            SemanticProperties.Hint="Basculez pour modifier ce paramÃ¨tre" />
                                </StackLayout>
                            </Frame>

                            <!-- Safety Alerts -->
                            <Frame BackgroundColor="{StaticResource Gray100}"
                                   CornerRadius="16"
                                   HasShadow="False"
                                   Padding="16">
                                <StackLayout Orientation="Horizontal" Spacing="12">
                                    <Frame BackgroundColor="{StaticResource Danger}"
                                           CornerRadius="10"
                                           HasShadow="False"
                                           Padding="6"
                                           WidthRequest="32"
                                           HeightRequest="32"
                                           VerticalOptions="Center">
                                        <Label Text="âš ï¸"
                                               FontSize="14"
                                               TextColor="White"
                                               HorizontalOptions="Center"
                                               VerticalOptions="Center" />
                                    </Frame>
                                    <StackLayout HorizontalOptions="StartAndExpand" VerticalOptions="Center">
                                        <Label Text="Alertes de sÃ©curitÃ©"
                                               FontSize="14"
                                               FontAttributes="Bold"
                                               TextColor="{StaticResource TextPrimary}" />
                                        <Label Text="Informations importantes de sÃ©curitÃ©"
                                               FontSize="12"
                                               TextColor="{StaticResource Gray600}" />
                                    </StackLayout>
                                    <Switch IsToggled="{Binding SafetyAlerts}" 
                                            OnColor="{StaticResource Primary}"
                                            VerticalOptions="Center"
                                            AutomationId="SafetyAlertsSwitch"
                                            SemanticProperties.Description="Recevoir les alertes de sÃ©curitÃ© importantes"
                                            SemanticProperties.Hint="Basculez pour modifier ce paramÃ¨tre" />
                                </StackLayout>
                            </Frame>
                        </StackLayout>
                    </StackLayout>
                </Frame>

                <!-- Enhanced Save Preferences Button -->
                <Frame BackgroundColor="{StaticResource Primary}"
                       CornerRadius="20"
                       HasShadow="True"
                       Padding="0"
                       Margin="0,8,0,16"
                       IsVisible="{Binding IsEditMode, Converter={StaticResource InvertBoolConverter}}">
                    <Frame.Shadow>
                        <Shadow Brush="Black" Opacity="0.12" Radius="8" Offset="0,4" />
                    </Frame.Shadow>
                    <Button Text="ðŸ’¾ Enregistrer les prÃ©fÃ©rences"
                            Command="{Binding SavePreferencesCommand}"
                            BackgroundColor="Transparent"
                            TextColor="White"
                            FontSize="16"
                            FontAttributes="Bold"
                            Padding="24,16"
                            CornerRadius="20"
                            HorizontalOptions="Fill"
                            AutomationId="SavePreferencesButton"
                            SemanticProperties.Description="Enregistrer toutes vos prÃ©fÃ©rences modifiÃ©es"
                            SemanticProperties.Hint="Appuyez deux fois pour sauvegarder vos paramÃ¨tres" />
                </Frame>

            </StackLayout>
        </StackLayout>
    </ScrollView>
</ContentPage>